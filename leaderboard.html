<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeonCanvas ¬∑ Leaderboard ‚Äî Compat</title>
  <style>
    :root{
      --bg:#0a0e1a; --panel:#0d1321; --panel2:#0e1420; --border:#1e293b;
      --ink:#f0f4f8; --muted:#94a3b8; --chip:#0e1420;
      --accent:#8b5cf6; --accent-a:#8b5cf6; --accent-b:#ec4899; --accent-c:#06b6d4;
      --glow-purple:rgba(139,92,246,0.4); --glow-pink:rgba(236,72,153,0.35);
      --like:#60a5fa; --love:#fb7185; --wow:#fbbf24; --fire:#fb923c; --clap:#34d399;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
      background:radial-gradient(circle at 30% 40%, rgba(139,92,246,0.1), transparent 50%),
                 radial-gradient(circle at 70% 60%, rgba(236,72,153,0.08), transparent 55%), var(--bg)}
    .bg-layer{position:fixed; inset:0; z-index:-1; background:transparent;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)} 
    .bg-layer.has-image{background-size:cover;background-position:center;background-repeat:no-repeat;
      box-shadow:0 0 80px rgba(0,0,0,0.5) inset}

    .topbar{max-width:1120px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent),var(--accent-b));
      box-shadow:0 8px 24px var(--glow-pink), 0 0 40px var(--glow-purple) inset;font-weight:700;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
    .logo:hover{transform:scale(1.05);box-shadow:0 12px 32px var(--glow-pink), 0 0 50px var(--glow-purple) inset}
    .nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px}
    .tabs{display:flex;gap:8px;background:rgba(15,23,36,0.6);border-radius:999px;padding:6px;
      backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.06)}
    .tab{background:transparent;border:0;color:#cbd5e1;border-radius:999px;padding:7px 14px;font-size:13px;cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);text-decoration:none}
    .tab:hover{transform:translateY(-1px);color:var(--ink)} 
    .tab.is-active{background:linear-gradient(90deg,var(--accent),var(--accent-b));color:#fff;
      box-shadow:0 8px 24px var(--glow-purple), 0 4px 12px var(--glow-pink)}
    .nav-rt{display:flex;align-items:center;gap:10px}
    .ghost-btn{background:linear-gradient(135deg,#3b82f6,#7c3aed);border:0;padding:8px;border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .me-chip{background:var(--chip);padding:8px 12px;border-radius:999px;font-size:13px}

    .wrap{max-width:1120px;margin:8px auto 24px;display:grid;grid-template-columns:1fr .9fr;gap:24px}
    .card{background:rgba(13,19,33,0.7);border:1px solid var(--border); border-radius:20px; padding:20px; 
      box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 1px rgba(139,92,246,0.15) inset;
      backdrop-filter:blur(16px);transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.4), 0 0 2px var(--glow-purple) inset}

    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:#9aa6b2}
    .field input,.field select{background:rgba(11,18,32,0.4);border:2px solid rgba(139,92,246,0.2);border-radius:12px;
      color:var(--ink);padding:10px 12px;font-size:14px;outline:none;backdrop-filter:blur(8px);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
    .field input:focus,.field select:focus{border-color:var(--accent);background:rgba(11,18,32,0.6);
      box-shadow:0 0 0 3px rgba(139,92,246,0.15), 0 4px 12px rgba(0,0,0,0.2)}

    .lb{margin-top:10px}
    .row{display:grid;grid-template-columns:48px 1fr 120px 160px;gap:12px;align-items:center;padding:12px;
      border-bottom:1px solid rgba(30,41,59,0.4);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      border-radius:12px;margin-bottom:4px}
    .row:hover{background:rgba(139,92,246,0.06);transform:translateX(4px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15), 0 0 20px rgba(139,92,246,0.08) inset}
    .row.head{color:#a5b4fc;background:rgba(11,18,32,0.6);border-radius:14px;border:1px solid rgba(139,92,246,0.2);
      box-shadow:0 4px 16px rgba(0,0,0,0.2)}
    .row.head .cell{font-weight:600}
    .cell{display:flex;align-items:center;gap:8px}
    .rank-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3150;background:#0b1220;padding:4px 8px;border-radius:999px;font-size:12px}
    .pos{width:32px;height:32px;border-radius:999px;
      background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(236,72,153,0.1));
      border:1px solid rgba(139,92,246,0.3);display:flex;align-items:center;justify-content:center;font-weight:700;
      box-shadow:0 4px 12px rgba(0,0,0,0.2), 0 0 16px var(--glow-purple) inset;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
    .pos:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(0,0,0,0.3), 0 0 24px var(--glow-purple) inset}
    .avatar{width:44px;height:44px;border-radius:999px;
      background:linear-gradient(135deg,rgba(139,92,246,0.12),rgba(236,72,153,0.08));
      border:2px solid rgba(139,92,246,0.25);display:flex;align-items:center;justify-content:center;overflow:hidden;font-weight:700;
      box-shadow:0 4px 12px rgba(0,0,0,0.2), 0 0 16px var(--glow-purple) inset;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
    .avatar:hover{transform:scale(1.08);box-shadow:0 6px 16px rgba(0,0,0,0.3), 0 0 24px var(--glow-purple) inset}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .name{font-weight:600} .muted{color:#94a3b8;font-size:12px}
    .points{font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent-b));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:15px}
    .btn{border:0;border-radius:999px;padding:10px 16px;color:var(--ink);cursor:pointer;font-weight:500;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);
      opacity:0;transition:opacity 0.3s ease}
    .btn:hover{transform:translateY(-2px)}
    .btn:hover::before{opacity:1}
    .btn.ghost{background:rgba(11,18,32,0.5);border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(8px)}
    .btn.primary{background:linear-gradient(90deg,var(--accent-c),var(--accent));
      box-shadow:0 8px 24px rgba(139,92,246,0.35), 0 4px 12px rgba(6,182,212,0.2)}
    .btn.primary:hover{box-shadow:0 12px 32px rgba(139,92,246,0.5), 0 6px 16px rgba(6,182,212,0.3)}
    .small{font-size:12px;color:#a5b4fc}
  @media (max-width: 900px){.wrap{grid-template-columns:1fr}.row{grid-template-columns:36px 1fr 92px 110px}}
  use-chat-gpt-ai, use-chat-gpt-ai-content-menu,
  use-chat-gpt-ai *, use-chat-gpt-ai-content-menu *,
  [class*="use-chat-gpt-ai"], [class*="use-chat-gpt-ai-content-menu"]{display:none !important}
  </style>

  <script>
    // Feature flags loader (GPT-5 enablement)
    (function loadFlags(){
      var KEY='neon_flags_v1';
      function apply(flags){
        try{
          window.__GPT5_ENABLED__ = !!(flags && flags.gpt5Enabled);
          window.__AI_MODEL__ = (flags && flags.aiModel) || 'gpt-5';
          document.documentElement.classList.toggle('gpt5-enabled', !!(flags && flags.gpt5Enabled));
        }catch(e){}
      }
      try{
        fetch('flags.json', { cache:'no-store' }).then(function(r){
          if(!r.ok) throw new Error('flags '+r.status);
          return r.json();
        }).then(function(json){ try{ localStorage.setItem(KEY, JSON.stringify({ ts: Date.now(), gpt5Enabled: !!json.gpt5Enabled, aiModel: json.aiModel||'gpt-5' })); }catch(e){}
          apply(json);
        }).catch(function(){
          try{ var cached = JSON.parse(localStorage.getItem(KEY)||'null')||{}; apply(cached); }catch(e){}
        });
      }catch(err){ try{ var cached = JSON.parse(localStorage.getItem(KEY)||'null')||{}; apply(cached); }catch(e){} }
    })();
  </script>
</head>
<body>
  <div id="bg-layer" class="bg-layer"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo">NC</div>
      <div>
        <h1>NeonCanvas</h1>
        <p class="small">Leaderboard (Top 15)</p>
      </div>
    </div>
    <nav class="nav">
      <div class="tabs">
        <a href="index.html" class="tab">Home</a>
        <a href="leaderboard.html" class="tab is-active">Leaderboard</a>
        <a href="profile.html" class="tab">Profile</a>
      </div>
      <div class="nav-rt">
        <label class="ghost-btn" title="Set background image (upload)">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 24 24"><path d="M21 19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h6l2 2h6a2 2 0 0 1 2 2v10zM8 13l2.5 3 3.5-4.5L18 17H6l2-4z"/></svg>
          <span>BG</span><input id="bg-file" type="file" accept="image/*" hidden />
        </label>
        <button id="bg-reset" class="ghost-btn" title="Reset BG">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 24 24"><path d="M12 6V3L8 7l4 4V8c2.757 0 5 2.243 5 5a5 5 0 0 1-9.584 2.001l-1.832.804A7 7 0 1 0 12 6z"/></svg>
          <span>Reset</span>
        </button>
        <div class="me-chip" id="me-chip">User</div>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 style="margin:0">Top 15 Students</h2>
      <div class="controls">
        <div class="field">
          <label>Rank filter</label>
          <select id="rank-filter"></select>
        </div>
        <div class="field" style="flex:1 1 220px">
          <label>Search</label>
          <input id="search" placeholder="–ù—ç—Ä—ç—ç—Ä —Ö–∞–π—Ö..." />
        </div>
        <div style="align-self:flex-end;display:flex;gap:8px;margin-left:auto">
          <button id="seed-btn" class="btn ghost" title="Re-seed demo data">Re-seed demo 15</button>
          <button id="export-btn" class="btn primary">Export CSV</button>
        </div>
      </div>

      <div class="lb" id="lb">
        <div class="row head">
          <div class="cell">#</div>
          <div class="cell">–û—é—É—Ç–∞–Ω</div>
          <div class="cell">–û–Ω–æ–æ</div>
          <div class="cell">Rank</div>
        </div>
        <div id="lb-body"></div>
      </div>
      <div class="small" style="margin-top:8px">* –û–Ω–æ–æ –Ω—å demo ”©–≥”©–≥–¥”©–ª. –•—ç—Ä—ç–≤ Lessons/Posts‚Äë–æ–æ—Å –±–æ–¥–∏—Ç –æ–Ω–æ–æ –∞—à–∏–≥–ª–∞—Ö –±–æ–ª –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π–≥ –Ω—ç–º–∂ –±–æ–ª–Ω–æ.</div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">–¢–∞–π–ª–±–∞—Ä</h3>
      <p class="small">–≠–Ω—ç —Ö—É—É–¥–∞—Å 15 —Å—É—Ä–∞–≥—á–∏–π–≥ ”©”©—Ä ”©”©—Ä –æ–Ω–æ–æ/—Ä–∞–Ω–∫–∞–∞—Ä —Ö–∞—Ä—É—É–ª–Ω–∞. –†–∞–Ω–∫ —Ç–æ–æ—Ü–æ–æ–ª–æ—Ö –±–æ—Å–≥–æ:<br>
        0 (Novice) ¬∑ 20 (Glyph) ¬∑ 60 (Aether) ¬∑ 120 (Illusion) ¬∑ 200 (Astral) ¬∑ 350 (Ethereal) ¬∑ 550 (Lumen)</p>
      <p class="small">–ë–∞–π–Ω–≥—ã–Ω —Ö–∞–¥–≥–∞–ª–∞–ª—Ç <code>localStorage</code> –¥—ç—ç—Ä. ‚ÄúRe‚Äëseed demo 15‚Äù –¥–∞—Ä–≤–∞–ª –∞–Ω—Ö–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ –¥–∞—Ö–∏–Ω —Å—ç—Ä–≥—ç—ç–Ω—ç.</p>
    </aside>

  <!-- Admin modal (teachers only) -->
  <div id="admin-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:120">
    <div style="background:rgba(3,7,18,.95);border:1px solid #172033;border-radius:12px;padding:16px;max-width:720px;width:100%;margin:24px;box-shadow:0 24px 60px rgba(2,6,23,.6)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Leaderboard Admin</h3>
        <div>
          <button id="admin-close" class="btn ghost">Close</button>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">
        <input id="new-name" placeholder="Name" style="flex:1;padding:8px;border-radius:8px;background:#071122;border:1px solid #172033;color:#fff" />
        <input id="new-avatar" placeholder="Avatar initials" style="width:140px;padding:8px;border-radius:8px;background:#071122;border:1px solid #172033;color:#fff" />
        <input id="new-pts" placeholder="Points" type="number" style="width:120px;padding:8px;border-radius:8px;background:#071122;border:1px solid #172033;color:#fff" />
        <button id="add-user" class="btn primary">Add user</button>
      </div>
      <div id="admin-list" style="max-height:380px;overflow:auto;border-top:1px dashed #16202a;padding-top:8px"></div>
    </div>
  </div>
  </main>

  <script>
    (function removeInjectedChat(){
      var selectors=[
        'use-chat-gpt-ai',
        'use-chat-gpt-ai-content-menu',
        '[class*="use-chat-gpt-ai-content-menu"]',
        '[class*="use-chat-gpt-ai"]'
      ];
      function purge(root){
        if(!root || !root.querySelectorAll) return;
        selectors.forEach(function(sel){
          root.querySelectorAll(sel).forEach(function(node){ try{ node.remove(); }catch(_){} });
        });
      }
      purge(document);
      var observer=new MutationObserver(function(mutations){
        mutations.forEach(function(m){
          m.addedNodes && m.addedNodes.forEach(function(node){
            if(node && node.nodeType===1){
              if(node.shadowRoot) purge(node.shadowRoot);
              purge(node);
            }
          });
        });
      });
      try{ observer.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){}
      window.addEventListener('beforeunload',function(){ try{ observer.disconnect(); }catch(_){} });
    })();

    var LOCAL_KEYS = { BG:"neon_bg_v1", ME:"neon_me_v1" };
    var STUDENTS_KEY = "neon_students15_v1";

    var RANKS = [
      { name:"Novice Spark", icon:"‚ú®", min:0,   color:"#7f8cff" },
      { name:"Glyph Crafter", icon:"üîÆ", min:20,  color:"#b57bff" },
      { name:"Aether Painter", icon:"üåå", min:60,  color:"#d96bff" },
      { name:"Illusion Shaper", icon:"üåÄ", min:120, color:"#ff72d2" },
      { name:"Astral Designer", icon:"üí´", min:200, color:"#ff56b8" },
      { name:"Ethereal Master", icon:"üå†", min:350, color:"#ff3ca6" },
      { name:"Lumen Archmage", icon:"üî•‚ú®", min:550, color:"#ff2d95" }
    ];
    function getRank(points){ var cur=RANKS[0]; for(var i=0;i<RANKS.length;i++){ if(points>=RANKS[i].min) cur=RANKS[i]; } return cur; }
    function esc(s){ s=(s==null?"":String(s)); return s.replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}) }

    function seedStudents(){
      var arr = [
        { id:1001, name:"Anar M.",       avatar:"AM", pts:12  },
        { id:1002, name:"Bolor T.",      avatar:"BT", pts:22  },
        { id:1003, name:"Dulguun E.",    avatar:"DE", pts:65  },
        { id:1004, name:"Gantulga B.",   avatar:"GB", pts:125 },
        { id:1005, name:"Saranzaya N.",  avatar:"SN", pts:205 },
        { id:1006, name:"Nomin E.",      avatar:"NE", pts:360 },
        { id:1007, name:"Bilguun S.",    avatar:"BS", pts:560 },
        { id:1008, name:"Tergel D.",     avatar:"TD", pts:8   },
        { id:1009, name:"Tungalag O.",   avatar:"TO", pts:45  },
        { id:1010, name:"Uuganbayar J.", avatar:"UJ", pts:95  },
        { id:1011, name:"Khulan P.",     avatar:"KP", pts:150 },
        { id:1012, name:"Enkhjin L.",    avatar:"EL", pts:230 },
        { id:1013, name:"Mungunshagai A.", avatar:"MA", pts:310 },
        { id:1014, name:"Delgerbat K.",  avatar:"DK", pts:400 },
        { id:1015, name:"Sarnai U.",     avatar:"SU", pts:650 }
      ];
      try{ localStorage.setItem(STUDENTS_KEY, JSON.stringify(arr)); }catch(e){}
      return arr;
    }

    function loadStudents(){
      try{
        var raw = localStorage.getItem(STUDENTS_KEY) || "";
        if(!raw){ return seedStudents(); }
        var list = JSON.parse(raw);
        if(!list || !list.length){ return seedStudents(); }
        if(list.length<15){ return seedStudents(); } // ensure 15
        return list;
      }catch(e){
        return seedStudents();
      }
    }

    function applyBackgroundFromLS(){
      try{
        var bg = JSON.parse(localStorage.getItem(LOCAL_KEYS.BG) || "null");
        if(bg && bg.dataUrl){
          var layer = document.getElementById('bg-layer');
          layer.style.backgroundImage = 'linear-gradient(0deg, rgba(5,10,20,.55), rgba(5,10,20,.66)), url("'+bg.dataUrl+'")';
          layer.classList.add('has-image');
        }
      }catch(e){}
    }
    function applyMe(){
      try{
        var m = JSON.parse(localStorage.getItem(LOCAL_KEYS.ME) || "null");
        if(m && m.name){ var chip=document.getElementById('me-chip'); if(chip) chip.textContent=m.name; }
      }catch(e){}
    }

    function renderList(list){
      var filterSel = document.getElementById('rank-filter');
      var q = (document.getElementById('search').value||"").toLowerCase();
      var rankVal = filterSel.value || "all";

      var filtered = list.filter(function(s){
        var ok = true;
        if(q){ ok = s.name.toLowerCase().indexOf(q) >= 0; }
        if(ok && rankVal!=='all'){
          var rk = getRank(s.pts);
          ok = rk.name === rankVal;
        }
        return ok;
      });

      filtered.sort(function(a,b){
        return (b.pts - a.pts) || a.name.localeCompare(b.name);
      });

      var body = document.getElementById('lb-body');
      if(!filtered.length){ body.innerHTML = '<div class="row"><div class="cell">‚Äî</div><div class="cell">No results</div><div class="cell"></div><div class="cell"></div></div>'; return; }

      var isTeacher = (function(){ try{ var a = JSON.parse(localStorage.getItem('neon_auth_v1')||'null'); return a && a.role === 'teacher'; }catch(e){return false;} })();

      body.innerHTML = filtered.map(function(s,idx){
        var rk = getRank(s.pts);
        var controls = '';
        if(isTeacher){
          controls = '<div style="display:flex;gap:6px;align-items:center">'
            + '<button class="btn ghost" data-action="dec" data-id="'+s.id+'">-5</button>'
            + '<button class="btn ghost" data-action="inc" data-id="'+s.id+'">+5</button>'
            + '<button class="btn ghost" data-action="edit" data-id="'+s.id+'">Edit</button>'
            + '<button class="btn ghost" data-action="del" data-id="'+s.id+'">Del</button>'
            + '</div>';
        }
        return '<div class="row">'
          + '<div class="cell"><div class="pos">'+(idx+1)+'</div></div>'
          + '<div class="cell"><div class="avatar">'+esc(s.avatar||s.name[0]||"?")+'</div><div class="name">'+esc(s.name)+'</div></div>'
          + '<div class="cell"><div class="points">'+(Math.round((s.pts+Number.EPSILON)*10)/10)+'</div> <span class="muted">pts</span></div>'
          + '<div class="cell"><span class="rank-pill"><span>'+rk.icon+'</span><span>'+esc(rk.name)+'</span></span>' + controls + '</div>'
        + '</div>';
      }).join("");

      // attach teacher controls event handlers
      if(isTeacher){
        body.querySelectorAll('button[data-action]').forEach(function(btn){
          btn.addEventListener('click', function(){ var act=this.getAttribute('data-action'); var id=this.getAttribute('data-id'); if(act==='inc'){ adjustPoints(Number(id), +5); } else if(act==='dec'){ adjustPoints(Number(id), -5); } else if(act==='del'){ deleteUser(Number(id)); } else if(act==='edit'){ openAdminAndEdit(Number(id)); } });
        });
      }
    }

    function saveStudents(list){ try{ localStorage.setItem(STUDENTS_KEY, JSON.stringify(list)); }catch(e){ console.warn('save failed',e); } }

    function adjustPoints(id, delta){ var list = loadStudents(); var idx = list.findIndex(function(u){return u.id===id}); if(idx===-1) return; list[idx].pts = Math.max(0, (list[idx].pts||0) + delta); saveStudents(list); renderList(list); renderAdminList(list); }

    function deleteUser(id){ if(!confirm('Delete user '+id+'?')) return; var list = loadStudents(); var idx = list.findIndex(function(u){return u.id===id}); if(idx!==-1){ list.splice(idx,1); saveStudents(list); renderList(list); renderAdminList(list); } }

    function openAdminAndEdit(id){ openAdmin(); setTimeout(function(){ var el = document.querySelector('#admin-list [data-id="'+id+'"]'); if(!el) return; var inp = el.querySelector('.admin-pts'); if(inp){ inp.focus(); inp.select(); } }, 120); }

    function renderAdminList(list){ var out=document.getElementById('admin-list'); if(!out) return; out.innerHTML = list.map(function(u){ return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #071220" data-id="'+u.id+'">'
        + '<div style="display:flex;gap:12px;align-items:center"><div class="avatar">'+esc(u.avatar||u.name[0]||'?')+'</div><div><div style="font-weight:600">'+esc(u.name)+'</div><div class="muted">id: '+u.id+'</div></div></div>'
        + '<div style="display:flex;gap:8px;align-items:center">'
        + '<input class="admin-pts" type="number" value="'+(u.pts||0)+'" style="width:96px;padding:6px;border-radius:8px;background:#071122;border:1px solid #172033;color:#fff" />'
        + '<button class="btn primary admin-save" data-id="'+u.id+'">Save</button>'
        + '<button class="btn ghost admin-del" data-id="'+u.id+'">Delete</button>'
        + '</div></div>'; }).join('');

      // attach handlers
      out.querySelectorAll('.admin-save').forEach(function(b){ b.addEventListener('click', function(){ var id=Number(this.getAttribute('data-id')); var row = this.closest('[data-id]'); var v = row.querySelector('.admin-pts').value||0; var list = loadStudents(); var idx = list.findIndex(function(x){return x.id===id}); if(idx!==-1){ list[idx].pts = Number(v); saveStudents(list); renderList(list); renderAdminList(list); alert('Saved'); } }); });
      out.querySelectorAll('.admin-del').forEach(function(b){ b.addEventListener('click', function(){ var id=Number(this.getAttribute('data-id')); deleteUser(id); }); });
    }

    function openAdmin(){ var modal = document.getElementById('admin-modal'); if(!modal) return; modal.style.display = 'flex'; var list = loadStudents(); renderAdminList(list); }
    function closeAdmin(){ var modal = document.getElementById('admin-modal'); if(!modal) return; modal.style.display = 'none'; }

    function exportCSV(list){
      var head = 'Position,Name,Points,Rank\n';
      var sorted = list.slice().sort(function(a,b){ return (b.pts-a.pts) || a.name.localeCompare(b.name) });
      var rows = sorted.map(function(s, i){
        var rk = getRank(s.pts);
        return [i+1, '"'+s.name.replace(/"/g,'""')+'"', s.pts, '"'+rk.name+'"'].join(',');
      }).join('\n');
      var csv = head + rows;
      var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href=url; a.download='leaderboard.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
    }

    // --- Boot ---
    (function boot(){
      applyBackgroundFromLS(); applyMe();
      // fill filter
      var sel = document.getElementById('rank-filter');
      sel.innerHTML = '<option value="all">All ranks</option>' + RANKS.map(function(r){ return '<option value="'+r.name+'">'+r.icon+' '+r.name+'</option>'; }).join('');

      var list = loadStudents();
      renderList(list);

      // Wire controls
      document.getElementById('rank-filter').addEventListener('change', function(){ renderList(list); });
      document.getElementById('search').addEventListener('input', function(){ renderList(list); });
      document.getElementById('seed-btn').addEventListener('click', function(){ list = seedStudents(); renderList(list); });
      document.getElementById('export-btn').addEventListener('click', function(){ exportCSV(list); });

      // Admin button: visible to teachers
      try{
        var auth = JSON.parse(localStorage.getItem('neon_auth_v1')||'null');
        if(auth && auth.role === 'teacher'){
          var adminBtn = document.createElement('button'); adminBtn.textContent = 'Admin'; adminBtn.className='btn ghost';
          adminBtn.style.marginLeft='8px';
          adminBtn.addEventListener('click', openAdmin);
          document.querySelector('.controls').appendChild(adminBtn);
        }
      }catch(e){}

      // Admin modal controls
      var ac = document.getElementById('admin-close'); if(ac) ac.addEventListener('click', function(){ closeAdmin(); });
      var addBtn = document.getElementById('add-user'); if(addBtn){ addBtn.addEventListener('click', function(){ var name=document.getElementById('new-name').value||'New User'; var avatar=document.getElementById('new-avatar').value||name.slice(0,2); var pts=Number(document.getElementById('new-pts').value)||0; var list2=loadStudents(); var maxId = list2.reduce(function(m,x){return Math.max(m,x.id||0)},0); var id = maxId+1; list2.push({id:id,name:name,avatar:avatar,pts:pts}); saveStudents(list2); renderList(list2); renderAdminList(list2); document.getElementById('new-name').value=''; document.getElementById('new-avatar').value=''; document.getElementById('new-pts').value=''; }); }

      // BG upload/reset
      var bgF=document.getElementById('bg-file'); if(bgF){ bgF.addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; var reader=new FileReader(); reader.onload=function(){ try{ localStorage.setItem(LOCAL_KEYS.BG, JSON.stringify({dataUrl:reader.result})); }catch(err){}; applyBackgroundFromLS(); }; reader.readAsDataURL(f); }); }
      document.getElementById('bg-reset').addEventListener('click', function(){ try{ localStorage.removeItem(LOCAL_KEYS.BG); }catch(e){}; var layer=document.getElementById('bg-layer'); layer.style.backgroundImage=''; layer.classList.remove('has-image'); });

      // Sync bg across tabs if BroadcastChannel exists
      var bus=null; try{ bus=new BroadcastChannel('neon_sync'); }catch(e){ bus=null; }
      if(bus){
        bus.onmessage=function(ev){
          var d=ev.data||{}; if(d.type==='BG_UPDATED'){ var u=d.payload && d.payload.dataUrl; if(u){ try{ localStorage.setItem(LOCAL_KEYS.BG, JSON.stringify({dataUrl:u})); }catch(e){} } applyBackgroundFromLS(); }
          else if(d.type==='ME_UPDATED'){ applyMe(); }
        };
      }
    })();
  </script>
</body>
</html>
