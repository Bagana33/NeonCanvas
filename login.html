<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeonCanvas · Sign in — Compat</title>
  <style>
    :root{
      --bg:#0a0e1a;
      --hero-a:#8b5cf6;
      --hero-b:#a78bfa;
      --hero-c:#6366f1;
      --panel:#0e1526;
      --panel2:#11182c;
      --ink:#0f172a;
      --muted:#64748b;
      --white:#ffffff;
      --input-bg:#f8fafc;
      --input-border:#e2e8f0;
      --accent:#8b5cf6;
      --glow-purple:rgba(139,92,246,0.4);
      --glow-pink:rgba(236,72,153,0.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:radial-gradient(ellipse 120% 100% at 50% 0%,rgba(139,92,246,0.15),transparent 70%),radial-gradient(ellipse 100% 80% at 80% 20%,rgba(236,72,153,0.12),transparent 65%),linear-gradient(160deg,#0a0e1a 0%,#0d1320 40%,#101828 100%);display:flex;align-items:center;justify-content:center;padding:32px;color:var(--ink);position:relative;overflow:hidden}
    body::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 20% 30%,rgba(139,92,246,0.08),transparent 50%),radial-gradient(circle at 80% 70%,rgba(236,72,153,0.06),transparent 50%);pointer-events:none;animation:glowPulse 12s ease-in-out infinite}
    @keyframes glowPulse{0%,100%{opacity:.5}50%{opacity:1}}
    .bg-layer{position:fixed;inset:0;z-index:-2;background:rgba(12,16,32,.85)}
    .bg-layer.has-image{background-size:cover;background-position:center;background-repeat:no-repeat}
    .overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(135deg,rgba(79,70,229,.65),rgba(236,72,153,.45))}
    .shell{position:relative;width:100%;max-width:1020px;min-height:600px;display:flex;border-radius:32px;overflow:hidden;box-shadow:0 40px 100px rgba(10,14,26,.4),0 0 80px rgba(139,92,246,.15);background:#fff;backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1)}
    .hero{flex:1;padding:64px 52px;background:linear-gradient(145deg,var(--hero-a),var(--hero-b),var(--hero-c));color:#fff;display:flex;flex-direction:column;justify-content:space-between;gap:36px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 40%,rgba(255,255,255,0.1),transparent 60%);pointer-events:none}
    .hero h1{margin:0;font-size:40px;font-weight:800;letter-spacing:-.02em;line-height:1.1}
    .hero p{margin:0;font-size:16px;line-height:1.7;color:rgba(255,255,255,.9);font-weight:400}
    .hero .dots{display:flex;gap:10px;margin-top:28px}
    .hero .dots span{width:40px;height:40px;border-radius:999px;background:rgba(255,255,255,.15);backdrop-filter:blur(8px);transition:transform .3s ease}
    .hero .dots span:hover{transform:scale(1.1)}
    .auth-card{flex:1;background:var(--white);padding:52px 64px;display:flex;flex-direction:column;gap:26px}
    .auth-header{display:flex;flex-direction:column;gap:8px}
    .auth-header h2{margin:0;font-size:32px;color:var(--ink);font-weight:800;letter-spacing:-.02em}
    .auth-header p{margin:0;font-size:14px;color:var(--muted);line-height:1.6}
    .field{display:flex;flex-direction:column;gap:8px}
    .field label{font-size:13px;font-weight:600;color:var(--ink);letter-spacing:-.01em}
    .field input,.field select{border-radius:14px;border:2px solid var(--input-border);background:var(--input-bg);padding:14px 16px;font-size:15px;color:var(--ink);outline:none;transition:all .25s cubic-bezier(0.4,0,0.2,1);font-weight:500}
    .field input:focus,.field select:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(139,92,246,.12),0 8px 24px rgba(139,92,246,.15);transform:translateY(-1px)}
    .field input:hover,.field select:hover{border-color:rgba(139,92,246,.4)}
    .field.hidden{display:none}
    .inline-row{display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:13px;color:var(--muted)}
    .inline-row a{color:var(--accent);text-decoration:none;font-weight:600}
    .inline-row a:hover{text-decoration:underline}
    .checkbox{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
    .checkbox input{width:16px;height:16px}
    .terms-note{display:none;font-size:12px;color:var(--muted);line-height:1.6}
    .terms-note a{color:var(--accent);text-decoration:none;font-weight:600}
    .terms-note a:hover{text-decoration:underline}
    .actions{display:flex;flex-direction:column;gap:12px}
    .btn{border:0;border-radius:999px;padding:16px 24px;font-size:16px;font-weight:700;cursor:pointer;transition:all .3s cubic-bezier(0.4,0,0.2,1);letter-spacing:-.01em}
    .btn.primary{background:linear-gradient(135deg,#8b5cf6,#a78bfa);color:#fff;box-shadow:0 20px 40px rgba(139,92,246,.4),0 0 40px rgba(139,92,246,.2);position:relative;overflow:hidden}
    .btn.primary::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.2),transparent);opacity:0;transition:opacity .3s ease}
    .btn.primary:hover{transform:translateY(-2px);box-shadow:0 24px 50px rgba(139,92,246,.5),0 0 60px rgba(139,92,246,.3)}
    .btn.primary:hover::before{opacity:1}
    .btn.primary:active{transform:translateY(0)}
    .btn.ghost{background:rgba(139,92,246,.08);border:2px solid rgba(139,92,246,.2);color:var(--accent);font-weight:600}
    .btn.ghost:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(139,92,246,.2);background:rgba(139,92,246,.12);border-color:rgba(139,92,246,.35)}
    .status{min-height:16px;font-size:13px;color:#facc15}
    .status.error{color:#f87171}
    .footer-links{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted)}
    .footer-links a{color:var(--accent);font-weight:600;text-decoration:none}
    .footer-links a:hover{text-decoration:underline}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:18px;background:linear-gradient(135deg,#f472b6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;letter-spacing:-.01em;box-shadow:0 12px 28px rgba(244,114,182,.3),0 0 40px rgba(139,92,246,.2);position:relative}
    .logo::before{content:'';position:absolute;inset:-3px;background:linear-gradient(135deg,#f472b6,#8b5cf6);border-radius:20px;opacity:.25;filter:blur(12px);z-index:-1}
    .brand-text{display:flex;flex-direction:column}
    .brand-text h3{margin:0;font-size:20px;color:#fff;font-weight:800;letter-spacing:-.02em}
    .brand-text span{font-size:13px;color:rgba(255,255,255,.8);font-weight:500}
  use-chat-gpt-ai, use-chat-gpt-ai-content-menu,
  use-chat-gpt-ai *, use-chat-gpt-ai-content-menu *,
  [class*="use-chat-gpt-ai"], [class*="use-chat-gpt-ai-content-menu"]{display:none !important}
    @media (max-width:1024px){
      body{padding:24px}
      .shell{max-width:860px}
      .hero{padding:48px 40px}
      .auth-card{padding:40px}
    }

    @media (max-width:960px){
      body{padding:24px 20px;align-items:flex-start}
      .shell{flex-direction:column;max-width:560px;min-height:auto}
      .hero{border-radius:28px 28px 0 0;padding:40px;align-items:flex-start;text-align:left}
      .hero .dots{margin-top:16px}
      .auth-card{padding:36px 32px}
    }

    @media (max-width:720px){
      body{padding:20px 16px;align-items:flex-start}
      .hero{padding:32px;gap:24px}
      .hero h1{font-size:32px}
      .auth-card{padding:30px 24px;gap:20px}
      .actions{gap:10px}
    }

    @media (max-width:560px){
      body{padding:18px 14px;align-items:flex-start}
      .hero{padding:26px;text-align:center;align-items:center;gap:18px}
      .hero h1{font-size:28px}
      .hero p{font-size:14px}
      .hero .dots{display:none}
      .auth-card{padding:26px 22px}
      .shell{min-height:auto}
      .inline-row{flex-direction:column;align-items:flex-start;gap:10px}
      .actions .btn{width:100%}
      .footer-links{flex-direction:column;align-items:flex-start;gap:6px}
    }

    @media (max-width:420px){
      body{padding:16px 12px;align-items:flex-start}
      .shell{border-radius:22px}
      .hero{padding:22px}
      .auth-card{padding:22px 18px}
      .auth-header h2{font-size:24px}
      .auth-header p{font-size:12px}
      .btn{padding:12px}
    }
  </style>

  <script>
    window.__SUPABASE_URL__ = "https://jvnzbxmuasidddtzqycx.supabase.co";
    window.__SUPABASE_ANON_KEY__ = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnpieG11YXNpZGRkdHpxeWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTE0MzMsImV4cCI6MjA3ODMyNzQzM30.K6ZIZFxG9uk5YrK3Ebw2SDVX_f9ftXqrZxeeQw-Visc";
  </script>
</head>
<body>
  <div id="bg-layer" class="bg-layer"></div>
  <div class="overlay"></div>
  <div class="shell">
    <section class="hero">
      <div class="brand">
        <div class="logo">NC</div>
        <div class="brand-text">
          <h3>NeonCanvas</h3>
          <span>Design community with Supabase auth</span>
        </div>
      </div>
      <div>
        <h1>Welcome back!</h1>
        <p>Sign in to continue crafting, sharing, and tracking your creative journey. New here? Create an account in seconds.</p>
        <div class="dots"><span></span><span></span><span></span></div>
      </div>
    </section>
    <section class="auth-card">
      <div class="auth-header">
        <h2 id="auth-title">Sign In</h2>
        <p id="auth-sub">You can sign in to access your existing account.</p>
      </div>
      <div class="field"><label for="in-email">Имэйл</label><input id="in-email" type="email" placeholder="you@example.com" /></div>
      <div class="field" id="name-field"><label for="in-name">Нэр (Display name)</label><input id="in-name" placeholder="Жишээ: Enkhtuya D." /></div>
      <div class="field" id="initials-field"><label for="in-initials">Аватарын товчлол (шаардлагагүй)</label><input id="in-initials" placeholder="Жишээ: ED" /></div>
      <div class="field" id="role-field"><label for="in-role">Role</label>
        <select id="in-role">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>
      <div class="field"><label for="in-password">Нууц үг</label><input id="in-password" type="password" placeholder="••••••••" autocomplete="current-password" /></div>
      <div class="field" id="confirm-field"><label for="in-confirm">Нууц үг давт</label><input id="in-confirm" type="password" placeholder="••••••••" autocomplete="new-password" /></div>
      <div class="inline-row" id="remember-row">
        <label class="checkbox"><input id="remember" type="checkbox" checked /> Remember me</label>
        <a href="#" id="forgot-link">Forgot password?</a>
      </div>
      <div class="terms-note" id="terms-note">Бүртгүүлснээр та манай <a href="#">үйлчилгээний нөхцөл</a> болон <a href="#">нууцлалын бодлого</a>-той танилцсан гэж тооцно.</div>
      <div class="actions">
        <button id="btn-submit" class="btn primary">Sign In</button>
        <button id="btn-guest" class="btn ghost">Continue as Guest</button>
        <button id="btn-bg" class="btn ghost">Set Background</button>
        <input id="bg-file" type="file" accept="image/*" hidden />
      </div>
      <div id="status" class="status"></div>
      <div class="footer-links">
        <span id="mode-hint">New here?</span>
        <a href="#" id="switch-link">Create an Account</a>
      </div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    (function removeInjectedChat(){
      var selectors=[
        'use-chat-gpt-ai',
        'use-chat-gpt-ai-content-menu',
        '[class*="use-chat-gpt-ai-content-menu"]',
        '[class*="use-chat-gpt-ai"]'
      ];
      function purge(root){
        if(!root || !root.querySelectorAll) return;
        selectors.forEach(function(sel){
          root.querySelectorAll(sel).forEach(function(node){ try{ node.remove(); }catch(_){} });
        });
      }
      purge(document);
      var observer=new MutationObserver(function(mutations){
        mutations.forEach(function(m){
          m.addedNodes && m.addedNodes.forEach(function(node){
            if(node && node.nodeType===1){
              if(node.shadowRoot) purge(node.shadowRoot);
              purge(node);
            }
          });
        });
      });
      try{ observer.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){}
      window.addEventListener('beforeunload',function(){ try{ observer.disconnect(); }catch(_){} });
    })();

  var LOCAL_KEYS = { AUTH:"neon_auth_v1", ME:"neon_me_v1", BG:"neon_bg_v1", USERS: "neon_users_v1" };
    var SUPABASE_URL = (window.__SUPABASE_URL__||"").trim();
    var SUPABASE_ANON_KEY = (window.__SUPABASE_ANON_KEY__||"").trim();
    var supabaseClient = null;
    if(SUPABASE_URL && SUPABASE_ANON_KEY){
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }else{
      console.warn("Supabase config missing for login page");
    }

    (function restoreBG(){
      try{
        var raw = localStorage.getItem(LOCAL_KEYS.BG)||"null";
        var bg = JSON.parse(raw);
        if(bg && bg.dataUrl){
          var layer = document.getElementById('bg-layer');
          layer.style.backgroundImage = 'url("'+bg.dataUrl+'")';
          layer.classList.add('has-image');
        }
      }catch(e){}
    })();

    var bus=null; try{ bus=new BroadcastChannel('neon_sync'); }catch(e){ bus=null; }
    function broadcast(type,payload){ if(bus){ try{ bus.postMessage({type:type,payload:payload}); }catch(e){} } try{ localStorage.setItem('neon_ping', String(Date.now())); }catch(e){} }

    function setAuthLoggedIn(cfg){
      cfg = cfg || {};
      var email = (cfg.email||"").trim();
      var name = cfg.name || cfg.fullName || "User";
      var initials = cfg.initials || (name? name.split(' ').map(function(s){return s[0]}).join('').slice(0,2).toUpperCase() : "U");
      var supabaseId = cfg.supabaseId || (cfg.supabaseUser && (cfg.supabaseUser.id || cfg.supabaseUser.user_id));
      var role = cfg.role || (cfg.supabaseUser && cfg.supabaseUser.user_metadata && cfg.supabaseUser.user_metadata.role) || 'student';

      // load or init users registry
      var users = [];
      try{ users = JSON.parse(localStorage.getItem(LOCAL_KEYS.USERS) || "null") || []; }catch(e){ users = []; }

      var me = null;
      if(email){
        // attempt to find existing user by email
        for(var i=0;i<users.length;i++){ if(users[i].email === email){ me = Object.assign({}, users[i]); break; } }
        if(me){
          // update name/avatar if changed
          me.name = name || me.name;
          me.avatar = initials || me.avatar;
          me.supabaseId = supabaseId || me.supabaseId;
          me.role = role || me.role;
        } else {
          // create new user record
          me = { id: Date.now(), email: email, name: name, avatar: initials, bio: "", avatarImage: null, supabaseId: supabaseId||null, role: role };
          users.push(me);
        }
      } else {
        // guest or email-less user: create ephemeral user record (still persist so they appear in ME)
        me = { id: Date.now(), email: "", name: name || "Guest", avatar: initials || "G", bio: "", avatarImage: null, supabaseId: supabaseId||null, role: role };
        users.push(me);
      }

      // persist users registry and current ME
      try{
        localStorage.setItem(LOCAL_KEYS.USERS, JSON.stringify(users));
        localStorage.setItem(LOCAL_KEYS.ME, JSON.stringify(me));
        localStorage.setItem(LOCAL_KEYS.AUTH, JSON.stringify({ loggedIn:true, userId: me.id, email: email, name: me.name, at: Date.now(), role: role, supabaseId: supabaseId||null }));
      }catch(e){}
      broadcast('ME_UPDATED', me);
      broadcast('AUTH_CHANGED', { loggedIn:true });
    }
    function isLoggedIn(){ try{ var a = JSON.parse(localStorage.getItem(LOCAL_KEYS.AUTH)||"null"); return !!(a && a.loggedIn); }catch(e){ return false; } }
    if(isLoggedIn()) window.location.href='index.html';

    var mode = 'signin';
    var btnSubmit = document.getElementById('btn-submit');
    var confirmField = document.getElementById('confirm-field');
    var statusEl = document.getElementById('status');
    var nameField = document.getElementById('name-field');
    var initialsField = document.getElementById('initials-field');
    var roleField = document.getElementById('role-field');
    var authTitle = document.getElementById('auth-title');
    var authSub = document.getElementById('auth-sub');
    var modeHint = document.getElementById('mode-hint');
    var switchLink = document.getElementById('switch-link');
    var forgotLink = document.getElementById('forgot-link');
    var rememberRow = document.getElementById('remember-row');
    var termsNote = document.getElementById('terms-note');
    var nameInput = document.getElementById('in-name');
    var initialsInput = document.getElementById('in-initials');
    var roleSelect = document.getElementById('in-role');
    var passwordInput = document.getElementById('in-password');
    var confirmInput = document.getElementById('in-confirm');

    function setMode(next){
      mode = next;
      var isSignIn = mode === 'signin';
      confirmField.classList.toggle('hidden', isSignIn);
      nameField.classList.toggle('hidden', isSignIn);
      initialsField.classList.toggle('hidden', isSignIn);
      roleField.classList.toggle('hidden', isSignIn);
      if(rememberRow){ rememberRow.style.display = isSignIn ? 'flex' : 'none'; }
      if(termsNote){ termsNote.style.display = isSignIn ? 'none' : 'block'; }
      if(nameInput){ nameInput.required = !isSignIn; }
      if(confirmInput){
        confirmInput.required = !isSignIn;
        confirmInput.value = '';
      }
      if(roleSelect){ roleSelect.disabled = isSignIn; }
      if(passwordInput){ passwordInput.autocomplete = isSignIn ? 'current-password' : 'new-password'; }
      if(initialsInput && !isSignIn && !initialsInput.value && nameInput && nameInput.value){
        initialsInput.value = nameInput.value.split(' ').map(function(s){return s ? s[0] : '';}).join('').slice(0,2).toUpperCase();
      }
      btnSubmit.textContent = isSignIn ? 'Sign In' : 'Register';
      authTitle.textContent = isSignIn ? 'Sign In' : 'Create Account';
      authSub.textContent = isSignIn
        ? 'You can sign in to access your existing account.'
        : 'Fill in the details below to start your NeonCanvas journey.';
      modeHint.textContent = isSignIn ? 'New here?' : 'Already have an account?';
      switchLink.textContent = isSignIn ? 'Create an Account' : 'Sign In';
      statusEl.textContent='';
      statusEl.classList.remove('error');
    }

    switchLink.addEventListener('click', function(ev){
      ev.preventDefault();
      setMode(mode==='signin' ? 'signup' : 'signin');
    });
    if(forgotLink){
      forgotLink.addEventListener('click', function(ev){
        ev.preventDefault();
        alert('Forgot password? Supabase Auth > Password recovery-г идэвхжүүлээд имэйлээр сэргээх холбоос илгээнэ үү.');
      });
    }

    async function handleSubmit(){
      if(!supabaseClient){ alert('Supabase тохиргоо олдсонгүй.'); return; }
      var email = (document.getElementById('in-email').value||"").trim();
      var name  = (document.getElementById('in-name').value||"").trim();
      var ini   = (document.getElementById('in-initials').value||"").trim();
      var role  = (document.getElementById('in-role').value||'student');
      var password = (document.getElementById('in-password').value||"");
      var confirm = (document.getElementById('in-confirm').value||"");
      if(!email){ alert('Имэйл заавал хэрэгтэй.'); return; }
      if(!password){ alert('Нууц үг оруулна уу.'); return; }
      if(mode==='signup' && password.length < 6){ alert('Нууц үг дор хаяж 6 тэмдэгт байна.'); return; }
      if(mode==='signup' && password !== confirm){ alert('Нууц үг таарахгүй байна.'); return; }
      if(mode==='signup' && !name){ alert('Нэр оруулна уу.'); return; }
      statusEl.textContent = mode==='signup' ? 'Sign up хийж байна...' : 'Sign in хийж байна...';
      statusEl.classList.remove('error');
      btnSubmit.disabled = true;
      try{
        if(mode==='signup'){
          var signupRes = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
              data: { full_name: name, initials: ini, role: role }
            }
          });
          if(signupRes.error){ throw signupRes.error; }
          var user = signupRes.data && signupRes.data.user;
          if(!user){
            statusEl.textContent = 'Бүртгэл амжилттай. И-мэйлээ шалгана уу.';
            btnSubmit.disabled=false;
            return;
          }
          setAuthLoggedIn({ email: email, name: name, initials: ini, role: role, supabaseId: user.id, supabaseUser: user });
          window.location.href='index.html';
          return;
        }
        var signInRes = await supabaseClient.auth.signInWithPassword({ email:email, password:password });
        if(signInRes.error){ throw signInRes.error; }
        var userIn = signInRes.data && signInRes.data.user;
        if(!userIn){ throw new Error('Хэрэглэгч олдсонгүй.'); }
        var meta = (userIn.user_metadata)||{};
        setAuthLoggedIn({
          email: userIn.email||email,
          name: meta.full_name || name || userIn.email,
          initials: meta.initials || ini,
          role: meta.role || role,
          supabaseId: userIn.id,
          supabaseUser: userIn
        });
        window.location.href='index.html';
      }catch(err){
        console.error('Auth error', err);
        statusEl.textContent = (err && err.message) ? err.message : 'Алдаа гарлаа.';
        statusEl.classList.add('error');
      }finally{
        btnSubmit.disabled = false;
      }
    }

    btnSubmit.addEventListener('click', function(){ handleSubmit(); });
    document.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ var focused=document.activeElement; if(focused && focused.tagName==='INPUT'){ ev.preventDefault(); handleSubmit(); } } });

    document.getElementById('btn-guest').addEventListener('click', function(){
      // guest defaults to a student role
      setAuthLoggedIn({ email:"", name:"Guest", initials:"G", role: 'student' });
      window.location.href='index.html';
    });
    document.getElementById('btn-bg').addEventListener('click', function(){ document.getElementById('bg-file').click(); });
    document.getElementById('bg-file').addEventListener('change', function(e){
      var f=e.target.files && e.target.files[0]; if(!f) return;
      var reader=new FileReader();
      reader.onload=function(){
        var dataUrl = reader.result;
        try{ localStorage.setItem(LOCAL_KEYS.BG, JSON.stringify({dataUrl:dataUrl})); }catch(e){}
        var layer = document.getElementById('bg-layer');
        layer.style.backgroundImage = 'url("'+dataUrl+'")';
        layer.classList.add('has-image');
        broadcast('BG_UPDATED', {dataUrl:dataUrl});
      };
      reader.readAsDataURL(f);
    });

      setMode(mode);
  </script>
</body>
</html>
