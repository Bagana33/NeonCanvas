<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeonCanvas · Sign in — Compat</title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#0e1526; --panel2:#0b1220; --border:#1f2937;
      --accent-a:#7c3aed; --accent-b:#ec4899; --accent-c:#06b6d4; --ink:#e5e7eb; --muted:#94a3b8;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .bg-layer{position:fixed;inset:0;z-index:-1;background:var(--bg)}
    .bg-layer.has-image{background-size:cover;background-position:center;background-repeat:no-repeat}
    .overlay{position:fixed;inset:0;background:linear-gradient(0deg, rgba(5,10,20,.55), rgba(5,10,20,.66));z-index:-1}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:440px;background:rgba(14,21,38,.85);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 16px 48px rgba(0,0,0,.35)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .logo{width:48px;height:48px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-a),var(--accent-b));box-shadow:0 20px 40px rgba(236,72,153,.25);font-weight:700}
    h1{margin:0;font-size:18px} p.sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .field label{font-size:12px;color:#9aa6b2}
    .field input{background:var(--panel2);border:1px solid #172033;border-radius:10px;color:#fff;padding:10px;font-size:14px;outline:none}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
    .btn{border:0;border-radius:999px;padding:10px 14px;color:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent-c),var(--accent-a))}
    .btn.ghost{background:var(--panel2);border:1px solid #172033}
    .actions{display:flex;gap:8px;margin-top:16px}
    .small{font-size:12px;color:#a5b4fc}
  use-chat-gpt-ai, use-chat-gpt-ai-content-menu,
  use-chat-gpt-ai *, use-chat-gpt-ai-content-menu *,
  [class*="use-chat-gpt-ai"], [class*="use-chat-gpt-ai-content-menu"]{display:none !important}
    .tabs{display:flex;gap:8px;margin:16px 0 0}
    .tabs button{flex:1;border:1px solid #172033;background:var(--panel2);color:#cbd5e1;border-radius:999px;padding:10px;font-size:14px;cursor:pointer;transition:.15s}
    .tabs button.active{background:linear-gradient(90deg,var(--accent-c),var(--accent-a));color:#fff;box-shadow:0 12px 24px rgba(124,58,237,.35);border-color:transparent}
    .field.hidden{display:none}
    .status{margin-top:12px;font-size:12px;color:#facc15;min-height:16px}
    .status.error{color:#f87171}
  </style>

  <script>
    window.__SUPABASE_URL__ = "https://jvnzbxmuasidddtzqycx.supabase.co";
    window.__SUPABASE_ANON_KEY__ = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnpieG11YXNpZGRkdHpxeWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTE0MzMsImV4cCI6MjA3ODMyNzQzM30.K6ZIZFxG9uk5YrK3Ebw2SDVX_f9ftXqrZxeeQw-Visc";
  </script>
</head>
<body>
  <div id="bg-layer" class="bg-layer"></div><div class="overlay"></div>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">NC</div>
        <div>
          <h1>NeonCanvas</h1>
          <p class="sub">Sign in to continue</p>
        </div>
      </div>
      <div class="field"><label for="in-email">Имэйл</label><input id="in-email" type="email" placeholder="you@example.com" /></div>
      <div class="field"><label for="in-name">Нэр (Display name)</label><input id="in-name" placeholder="Жишээ: Enkhtuya D." /></div>
      <div class="field"><label for="in-initials">Аватарын товчлол (шаардлагагүй)</label><input id="in-initials" placeholder="Жишээ: ED" /></div>
      <div class="field"><label for="in-role">Role</label>
        <select id="in-role">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>
      <div class="field"><label for="in-password">Нууц үг</label><input id="in-password" type="password" placeholder="••••••••" autocomplete="current-password" /></div>
      <div class="field" id="confirm-field"><label for="in-confirm">Нууц үг давт</label><input id="in-confirm" type="password" placeholder="••••••••" autocomplete="new-password" /></div>
      <div class="tabs">
        <button id="tab-signin" class="active" type="button">Sign in</button>
        <button id="tab-signup" type="button">Register</button>
      </div>
      <div class="actions">
        <button id="btn-submit" class="btn primary" style="flex:1">Sign in</button>
        <button id="btn-guest" class="btn ghost" style="flex:1">Continue as Guest</button>
      </div>
      <div class="row">
        <label class="small"><input id="remember" type="checkbox" checked /> Remember me</label>
        <button id="btn-bg" class="btn ghost">Set Background</button>
        <input id="bg-file" type="file" accept="image/*" hidden />
      </div>
      <div id="status" class="status"></div>
      <p class="small" style="margin-top:12px">E-mail / password нь Supabase Auth дээр хадгалагдана. Demo зорилгоор Remember me нь браузерт state хадгална.</p>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    (function removeInjectedChat(){
      var selectors=[
        'use-chat-gpt-ai',
        'use-chat-gpt-ai-content-menu',
        '[class*="use-chat-gpt-ai-content-menu"]',
        '[class*="use-chat-gpt-ai"]'
      ];
      function purge(root){
        if(!root || !root.querySelectorAll) return;
        selectors.forEach(function(sel){
          root.querySelectorAll(sel).forEach(function(node){ try{ node.remove(); }catch(_){} });
        });
      }
      purge(document);
      var observer=new MutationObserver(function(mutations){
        mutations.forEach(function(m){
          m.addedNodes && m.addedNodes.forEach(function(node){
            if(node && node.nodeType===1){
              if(node.shadowRoot) purge(node.shadowRoot);
              purge(node);
            }
          });
        });
      });
      try{ observer.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){}
      window.addEventListener('beforeunload',function(){ try{ observer.disconnect(); }catch(_){} });
    })();

  var LOCAL_KEYS = { AUTH:"neon_auth_v1", ME:"neon_me_v1", BG:"neon_bg_v1", USERS: "neon_users_v1" };
    var SUPABASE_URL = (window.__SUPABASE_URL__||"").trim();
    var SUPABASE_ANON_KEY = (window.__SUPABASE_ANON_KEY__||"").trim();
    var supabaseClient = null;
    if(SUPABASE_URL && SUPABASE_ANON_KEY){
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }else{
      console.warn("Supabase config missing for login page");
    }

    (function restoreBG(){
      try{
        var raw = localStorage.getItem(LOCAL_KEYS.BG)||"null";
        var bg = JSON.parse(raw);
        if(bg && bg.dataUrl){
          var layer = document.getElementById('bg-layer');
          layer.style.backgroundImage = 'url("'+bg.dataUrl+'")';
          layer.classList.add('has-image');
        }
      }catch(e){}
    })();

    var bus=null; try{ bus=new BroadcastChannel('neon_sync'); }catch(e){ bus=null; }
    function broadcast(type,payload){ if(bus){ try{ bus.postMessage({type:type,payload:payload}); }catch(e){} } try{ localStorage.setItem('neon_ping', String(Date.now())); }catch(e){} }

    function setAuthLoggedIn(cfg){
      cfg = cfg || {};
      var email = (cfg.email||"").trim();
      var name = cfg.name || cfg.fullName || "User";
      var initials = cfg.initials || (name? name.split(' ').map(function(s){return s[0]}).join('').slice(0,2).toUpperCase() : "U");
      var supabaseId = cfg.supabaseId || (cfg.supabaseUser && (cfg.supabaseUser.id || cfg.supabaseUser.user_id));
      var role = cfg.role || (cfg.supabaseUser && cfg.supabaseUser.user_metadata && cfg.supabaseUser.user_metadata.role) || 'student';

      // load or init users registry
      var users = [];
      try{ users = JSON.parse(localStorage.getItem(LOCAL_KEYS.USERS) || "null") || []; }catch(e){ users = []; }

      var me = null;
      if(email){
        // attempt to find existing user by email
        for(var i=0;i<users.length;i++){ if(users[i].email === email){ me = Object.assign({}, users[i]); break; } }
        if(me){
          // update name/avatar if changed
          me.name = name || me.name;
          me.avatar = initials || me.avatar;
          me.supabaseId = supabaseId || me.supabaseId;
          me.role = role || me.role;
        } else {
          // create new user record
          me = { id: Date.now(), email: email, name: name, avatar: initials, bio: "", avatarImage: null, supabaseId: supabaseId||null, role: role };
          users.push(me);
        }
      } else {
        // guest or email-less user: create ephemeral user record (still persist so they appear in ME)
        me = { id: Date.now(), email: "", name: name || "Guest", avatar: initials || "G", bio: "", avatarImage: null, supabaseId: supabaseId||null, role: role };
        users.push(me);
      }

      // persist users registry and current ME
      try{
        localStorage.setItem(LOCAL_KEYS.USERS, JSON.stringify(users));
        localStorage.setItem(LOCAL_KEYS.ME, JSON.stringify(me));
        localStorage.setItem(LOCAL_KEYS.AUTH, JSON.stringify({ loggedIn:true, userId: me.id, email: email, name: me.name, at: Date.now(), role: role, supabaseId: supabaseId||null }));
      }catch(e){}
      broadcast('ME_UPDATED', me);
      broadcast('AUTH_CHANGED', { loggedIn:true });
    }
    function isLoggedIn(){ try{ var a = JSON.parse(localStorage.getItem(LOCAL_KEYS.AUTH)||"null"); return !!(a && a.loggedIn); }catch(e){ return false; } }
    if(isLoggedIn()) window.location.href='index.html';

    var mode = 'signin';
    var tabSignin = document.getElementById('tab-signin');
    var tabSignup = document.getElementById('tab-signup');
    var btnSubmit = document.getElementById('btn-submit');
    var confirmField = document.getElementById('confirm-field');
    var statusEl = document.getElementById('status');

    function setMode(next){
      mode = next;
      tabSignin.classList.toggle('active', mode==='signin');
      tabSignup.classList.toggle('active', mode==='signup');
      confirmField.classList.toggle('hidden', mode!=='signup');
      btnSubmit.textContent = mode==='signin' ? 'Sign in' : 'Register';
      statusEl.textContent='';
      statusEl.classList.remove('error');
    }

    tabSignin.addEventListener('click', function(){ setMode('signin'); });
    tabSignup.addEventListener('click', function(){ setMode('signup'); });

    async function handleSubmit(){
      if(!supabaseClient){ alert('Supabase тохиргоо олдсонгүй.'); return; }
      var email = (document.getElementById('in-email').value||"").trim();
      var name  = (document.getElementById('in-name').value||"").trim();
      var ini   = (document.getElementById('in-initials').value||"").trim();
      var role  = (document.getElementById('in-role').value||'student');
      var password = (document.getElementById('in-password').value||"");
      var confirm = (document.getElementById('in-confirm').value||"");
      if(!email){ alert('Имэйл заавал хэрэгтэй.'); return; }
      if(!password){ alert('Нууц үг оруулна уу.'); return; }
      if(mode==='signup' && password.length < 6){ alert('Нууц үг дор хаяж 6 тэмдэгт байна.'); return; }
      if(mode==='signup' && password !== confirm){ alert('Нууц үг таарахгүй байна.'); return; }
      if(mode==='signup' && !name){ alert('Нэр оруулна уу.'); return; }
      statusEl.textContent = mode==='signup' ? 'Sign up хийж байна...' : 'Sign in хийж байна...';
      statusEl.classList.remove('error');
      btnSubmit.disabled = true;
      try{
        if(mode==='signup'){
          var signupRes = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
              data: { full_name: name, initials: ini, role: role }
            }
          });
          if(signupRes.error){ throw signupRes.error; }
          var user = signupRes.data && signupRes.data.user;
          if(!user){
            statusEl.textContent = 'Бүртгэл амжилттай. И-мэйлээ шалгана уу.';
            btnSubmit.disabled=false;
            return;
          }
          setAuthLoggedIn({ email: email, name: name, initials: ini, role: role, supabaseId: user.id, supabaseUser: user });
          window.location.href='index.html';
          return;
        }
        var signInRes = await supabaseClient.auth.signInWithPassword({ email:email, password:password });
        if(signInRes.error){ throw signInRes.error; }
        var userIn = signInRes.data && signInRes.data.user;
        if(!userIn){ throw new Error('Хэрэглэгч олдсонгүй.'); }
        var meta = (userIn.user_metadata)||{};
        setAuthLoggedIn({
          email: userIn.email||email,
          name: meta.full_name || name || userIn.email,
          initials: meta.initials || ini,
          role: meta.role || role,
          supabaseId: userIn.id,
          supabaseUser: userIn
        });
        window.location.href='index.html';
      }catch(err){
        console.error('Auth error', err);
        statusEl.textContent = (err && err.message) ? err.message : 'Алдаа гарлаа.';
        statusEl.classList.add('error');
      }finally{
        btnSubmit.disabled = false;
      }
    }

    btnSubmit.addEventListener('click', function(){ handleSubmit(); });
    document.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ var focused=document.activeElement; if(focused && focused.tagName==='INPUT'){ ev.preventDefault(); handleSubmit(); } } });

    document.getElementById('btn-guest').addEventListener('click', function(){
      // guest defaults to a student role
      setAuthLoggedIn({ email:"", name:"Guest", initials:"G", role: 'student' });
      window.location.href='index.html';
    });
    document.getElementById('btn-bg').addEventListener('click', function(){ document.getElementById('bg-file').click(); });
    document.getElementById('bg-file').addEventListener('change', function(e){
      var f=e.target.files && e.target.files[0]; if(!f) return;
      var reader=new FileReader();
      reader.onload=function(){
        var dataUrl = reader.result;
        try{ localStorage.setItem(LOCAL_KEYS.BG, JSON.stringify({dataUrl:dataUrl})); }catch(e){}
        var layer = document.getElementById('bg-layer');
        layer.style.backgroundImage = 'url("'+dataUrl+'")';
        layer.classList.add('has-image');
        broadcast('BG_UPDATED', {dataUrl:dataUrl});
      };
      reader.readAsDataURL(f);
    });
  </script>
</body>
</html>
