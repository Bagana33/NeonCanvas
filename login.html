<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeonCanvas · Sign in — Compat</title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#0e1526; --panel2:#0b1220; --border:#1f2937;
      --accent-a:#7c3aed; --accent-b:#ec4899; --accent-c:#06b6d4; --ink:#e5e7eb; --muted:#94a3b8;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .bg-layer{position:fixed;inset:0;z-index:-1;background:var(--bg)}
    .bg-layer.has-image{background-size:cover;background-position:center;background-repeat:no-repeat}
    .overlay{position:fixed;inset:0;background:linear-gradient(0deg, rgba(5,10,20,.55), rgba(5,10,20,.66));z-index:-1}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:440px;background:rgba(14,21,38,.85);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 16px 48px rgba(0,0,0,.35)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .logo{width:48px;height:48px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-a),var(--accent-b));box-shadow:0 20px 40px rgba(236,72,153,.25);font-weight:700}
    h1{margin:0;font-size:18px} p.sub{margin:4px 0 0;color:var(--muted);font-size:12px}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .field label{font-size:12px;color:#9aa6b2}
    .field input{background:var(--panel2);border:1px solid #172033;border-radius:10px;color:#fff;padding:10px;font-size:14px;outline:none}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
    .btn{border:0;border-radius:999px;padding:10px 14px;color:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent-c),var(--accent-a))}
    .btn.ghost{background:var(--panel2);border:1px solid #172033}
    .actions{display:flex;gap:8px;margin-top:16px}
    .small{font-size:12px;color:#a5b4fc}
    use-chat-gpt-ai, use-chat-gpt-ai *, [class*="use-chat-gpt-ai"]{display:none !important}
  </style>
</head>
<body>
  <div id="bg-layer" class="bg-layer"></div><div class="overlay"></div>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">NC</div>
        <div>
          <h1>NeonCanvas</h1>
          <p class="sub">Sign in to continue</p>
        </div>
      </div>
      <div class="field"><label for="in-email">Имэйл</label><input id="in-email" type="email" placeholder="you@example.com" /></div>
      <div class="field"><label for="in-name">Нэр (Display name)</label><input id="in-name" placeholder="Жишээ: Enkhtuya D." /></div>
      <div class="field"><label for="in-initials">Аватарын товчлол (шаардлагагүй)</label><input id="in-initials" placeholder="Жишээ: ED" /></div>
      <div class="field"><label for="in-role">Role</label>
        <select id="in-role">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>
      <div class="actions">
        <button id="btn-signin" class="btn primary" style="flex:1">Sign in</button>
        <button id="btn-guest" class="btn ghost" style="flex:1">Continue as Guest</button>
      </div>
      <div class="row">
        <label class="small"><input id="remember" type="checkbox" checked /> Remember me</label>
        <button id="btn-bg" class="btn ghost">Set Background</button>
        <input id="bg-file" type="file" accept="image/*" hidden />
      </div>
      <p class="small" style="margin-top:12px">Demo only — no server. Auth state is stored in your browser (localStorage).</p>
    </div>
  </div>

  <script>
    (function removeInjectedChat(){
      var selectors=['use-chat-gpt-ai','[class*="use-chat-gpt-ai"]'];
      function purge(root){
        if(!root || !root.querySelectorAll) return;
        selectors.forEach(function(sel){
          root.querySelectorAll(sel).forEach(function(node){ try{ node.remove(); }catch(_){} });
        });
      }
      purge(document);
      var observer=new MutationObserver(function(mutations){
        mutations.forEach(function(m){
          m.addedNodes && m.addedNodes.forEach(function(node){
            if(node && node.nodeType===1){
              if(node.shadowRoot) purge(node.shadowRoot);
              purge(node);
            }
          });
        });
      });
      try{ observer.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){}
      window.addEventListener('beforeunload',function(){ try{ observer.disconnect(); }catch(_){} });
    })();

  var LOCAL_KEYS = { AUTH:"neon_auth_v1", ME:"neon_me_v1", BG:"neon_bg_v1", USERS: "neon_users_v1" };
    (function restoreBG(){
      try{
        var raw = localStorage.getItem(LOCAL_KEYS.BG)||"null";
        var bg = JSON.parse(raw);
        if(bg && bg.dataUrl){
          var layer = document.getElementById('bg-layer');
          layer.style.backgroundImage = 'url("'+bg.dataUrl+'")';
          layer.classList.add('has-image');
        }
      }catch(e){}
    })();

    var bus=null; try{ bus=new BroadcastChannel('neon_sync'); }catch(e){ bus=null; }
    function broadcast(type,payload){ if(bus){ try{ bus.postMessage({type:type,payload:payload}); }catch(e){} } try{ localStorage.setItem('neon_ping', String(Date.now())); }catch(e){} }

    function setAuthLoggedIn(cfg){
      cfg = cfg || {};
      var email = (cfg.email||"").trim();
      var name = cfg.name || "User";
      var initials = cfg.initials || (name? name.split(' ').map(function(s){return s[0]}).join('').slice(0,2).toUpperCase() : "U");

      // load or init users registry
      var users = [];
      try{ users = JSON.parse(localStorage.getItem(LOCAL_KEYS.USERS) || "null") || []; }catch(e){ users = []; }

      var me = null;
      if(email){
        // attempt to find existing user by email
        for(var i=0;i<users.length;i++){ if(users[i].email === email){ me = Object.assign({}, users[i]); break; } }
        if(me){
          // update name/avatar if changed
          me.name = name || me.name;
          me.avatar = initials || me.avatar;
        } else {
          // create new user record
          me = { id: Date.now(), email: email, name: name, avatar: initials, bio: "", avatarImage: null };
          users.push(me);
        }
      } else {
        // guest or email-less user: create ephemeral user record (still persist so they appear in ME)
        me = { id: Date.now(), email: "", name: name || "Guest", avatar: initials || "G", bio: "", avatarImage: null };
        users.push(me);
      }

      // persist users registry and current ME
      try{
        localStorage.setItem(LOCAL_KEYS.USERS, JSON.stringify(users));
        localStorage.setItem(LOCAL_KEYS.ME, JSON.stringify(me));
        // save role selection into AUTH so other pages can read permissions
        var role = cfg.role || 'student';
        localStorage.setItem(LOCAL_KEYS.AUTH, JSON.stringify({ loggedIn:true, userId: me.id, email: email, name: me.name, at: Date.now(), role: role }));
      }catch(e){}
      broadcast('ME_UPDATED', me);
      broadcast('AUTH_CHANGED', { loggedIn:true });
    }
    function isLoggedIn(){ try{ var a = JSON.parse(localStorage.getItem(LOCAL_KEYS.AUTH)||"null"); return !!(a && a.loggedIn); }catch(e){ return false; } }
    if(isLoggedIn()) window.location.href='index.html';

    document.getElementById('btn-signin').addEventListener('click', function(){
      var email = (document.getElementById('in-email').value||"").trim();
      var name  = (document.getElementById('in-name').value||"").trim();
      var ini   = (document.getElementById('in-initials').value||"").trim();
      var role  = (document.getElementById('in-role').value||'student');
      if(!email || !name){ alert('Имэйл болон Нэр 2-ыг бөглөнө үү.'); return; }
      setAuthLoggedIn({email:email,name:name,initials:ini, role: role});
      window.location.href='index.html';
    });
    document.getElementById('btn-guest').addEventListener('click', function(){
      // guest defaults to a student role
      setAuthLoggedIn({ email:"", name:"Guest", initials:"G", role: 'student' });
      window.location.href='index.html';
    });
    document.getElementById('btn-bg').addEventListener('click', function(){ document.getElementById('bg-file').click(); });
    document.getElementById('bg-file').addEventListener('change', function(e){
      var f=e.target.files && e.target.files[0]; if(!f) return;
      var reader=new FileReader();
      reader.onload=function(){
        var dataUrl = reader.result;
        try{ localStorage.setItem(LOCAL_KEYS.BG, JSON.stringify({dataUrl:dataUrl})); }catch(e){}
        var layer = document.getElementById('bg-layer');
        layer.style.backgroundImage = 'url("'+dataUrl+'")';
        layer.classList.add('has-image');
        broadcast('BG_UPDATED', {dataUrl:dataUrl});
      };
      reader.readAsDataURL(f);
    });
  </script>
</body>
</html>
