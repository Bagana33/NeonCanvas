<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeonCanvas · Admin Dashboard — Compat</title>
  <style>
    :root{
      --bg:#050b1c;
      --overlay:#0f172a;
      --panel:#091428;
      --panel-2:#0f1d37;
      --panel-3:#132447;
      --border:rgba(148,163,184,0.14);
      --accent:#7c3aed;
      --accent-b:#ec4899;
      --accent-c:#22d3ee;
      --ink:#e2e8f0;
      --ink-strong:#f8fafc;
      --muted:#9aa6b2;
      --good:#22c55e;
      --warn:#f97316;
      --danger:#ef4444;
      --shadow:0 24px 60px rgba(15,23,42,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(120% 120% at 50% 20%,rgba(124,58,237,.18),transparent),linear-gradient(160deg,#050b1c 0%,#060c1e 32%,#081326 70%,#0c1b33 100%);color:var(--ink);padding:24px;display:flex;flex-direction:column;min-height:100vh}
    .dashboard{flex:1;display:flex;flex-direction:column;max-width:1260px;margin:0 auto;width:100%;position:relative;z-index:1}
    .glow{position:fixed;inset:0;pointer-events:none;background:radial-gradient(55% 55% at 20% 10%,rgba(124,58,237,.16),transparent),radial-gradient(40% 40% at 80% 12%,rgba(236,72,153,.14),transparent);z-index:0}
    .topbar{background:linear-gradient(135deg,rgba(17,26,46,0.92),rgba(9,18,40,0.92));border:1px solid rgba(124,58,237,0.18);border-radius:22px;padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:52px;height:52px;border-radius:18px;background:linear-gradient(135deg,#7c3aed,#ec4899);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#fff;box-shadow:0 18px 32px rgba(124,58,237,.25)}
    .brand h1{margin:0;font-size:22px;font-weight:700;color:var(--ink-strong)}
    .brand span{font-size:13px;color:var(--muted)}
    .top-actions{display:flex;align-items:center;gap:12px}
    .badge{padding:8px 12px;border-radius:999px;background:rgba(124,58,237,.18);border:1px solid rgba(124,58,237,.4);font-size:12px;color:var(--ink-strong);text-transform:uppercase;letter-spacing:.08em}
    .top-btn{border:1px solid rgba(148,163,184,0.18);background:rgba(15,27,53,0.6);color:var(--ink);padding:10px 14px;border-radius:12px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform .16s ease,box-shadow .16s ease}
    .top-btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(15,23,42,.28)}
    .main{margin-top:24px;flex:1;display:flex;gap:24px;min-height:0}
    .sidebar{width:230px;background:rgba(11,24,44,0.82);border:1px solid rgba(124,58,237,0.12);border-radius:20px;padding:18px;display:flex;flex-direction:column;gap:10px;box-shadow:0 18px 42px rgba(8,14,26,.42)}
    .nav-btn{border:1px solid transparent;background:rgba(16,28,52,0.74);color:var(--ink);padding:12px 14px;border-radius:14px;font-size:14px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .18s ease}
    .nav-btn span{font-size:12px;color:var(--muted)}
    .nav-btn:hover{border-color:rgba(124,58,237,0.35);transform:translateX(2px)}
    .nav-btn.is-active{background:linear-gradient(135deg,rgba(124,58,237,.28),rgba(236,72,153,.24));border-color:rgba(124,58,237,0.6);box-shadow:0 16px 36px rgba(124,58,237,.32)}
    .content{flex:1;background:rgba(9,18,40,0.92);border:1px solid rgba(124,58,237,0.12);border-radius:24px;padding:28px;overflow:auto;position:relative}
    .panel{display:none;flex-direction:column;gap:24px}
    .panel.is-active{display:flex}
    .grid{display:grid;gap:18px}
    .grid.metrics{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:linear-gradient(145deg,rgba(16,28,52,0.95),rgba(11,18,34,0.95));border:1px solid rgba(124,58,237,0.1);border-radius:18px;padding:20px;box-shadow:0 14px 32px rgba(7,15,28,.38)}
    .card h2{margin:0;font-size:18px;color:var(--ink-strong)}
    .card h3{margin:0;font-size:16px;color:var(--ink-strong)}
    .metric-value{font-size:30px;font-weight:700;color:#f8fafc;margin-top:4px}
    .metric-sub{font-size:12px;color:var(--muted);margin-top:6px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform .16s ease,box-shadow .16s ease}
    .btn.primary{background:linear-gradient(135deg,#6366f1,#a855f7);color:#fff;box-shadow:0 16px 32px rgba(99,102,241,.32)}
    .btn.secondary{background:rgba(99,102,241,.18);color:#c7d2fe;border:1px solid rgba(99,102,241,.35)}
    .btn.ghost{background:rgba(15,23,42,.6);color:var(--muted);border:1px solid rgba(148,163,184,.18)}
    .btn.danger{background:rgba(239,68,68,.16);color:#fca5a5;border:1px solid rgba(239,68,68,.4)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(15,23,42,.28)}
    .fields{display:grid;gap:14px}
    .fields.two{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;border-radius:12px;border:1px solid rgba(148,163,184,0.26);background:rgba(12,20,38,0.92);color:var(--ink);padding:12px 14px;font-size:14px;outline:none;transition:border-color .16s ease,box-shadow .16s ease}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.2)}
    textarea{min-height:96px;resize:vertical}
    table{width:100%;border-collapse:separate;border-spacing:0;background:rgba(11,22,42,.9);border:1px solid rgba(124,58,237,.12);border-radius:16px;overflow:hidden}
    th,td{text-align:left;padding:12px 14px;font-size:13px;color:var(--ink)}
    th{background:rgba(15,27,53,.88);font-size:12px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
    tr+tr td{border-top:1px solid rgba(148,163,184,.12)}
    .table-wrap{overflow:auto;border-radius:18px}
    .muted{color:var(--muted)}
    .status-banner{position:sticky;top:-12px;margin-bottom:16px;padding:12px 16px;border-radius:12px;font-size:13px;border:1px solid transparent;background:rgba(15,27,53,.8);color:var(--muted);opacity:0;transform:translateY(-8px);transition:opacity .2s ease,transform .2s ease}
    .status-banner.show{opacity:1;transform:translateY(0)}
    .status-banner.success{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.12);color:#bbf7d0}
    .status-banner.error{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);color:#fecaca}
    .badge-soft{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(124,58,237,.16);border:1px solid rgba(124,58,237,.28);font-size:12px;color:var(--ink)}
    .list{display:flex;flex-direction:column;gap:12px}
    .list-item{background:rgba(14,24,46,.9);border:1px solid rgba(124,58,237,.12);border-radius:14px;padding:14px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .list-item .actions{display:flex;gap:8px}
    .locked{margin-top:36px;padding:32px;border-radius:16px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.12);color:#fecaca;text-align:center}
    .hidden{display:none !important}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;background:rgba(148,163,184,.16);color:var(--ink);font-size:12px}
    .bg-preview{width:100%;min-height:160px;border-radius:14px;border:1px dashed rgba(148,163,184,.24);background:rgba(15,23,42,.6);display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
    .bg-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .split{display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
    .timeline{display:flex;flex-direction:column;gap:10px}
    .timeline-item{background:rgba(14,24,46,.85);border:1px solid rgba(148,163,184,.16);border-radius:12px;padding:12px}
    .timeline-item small{display:block;font-size:11px;color:var(--muted);margin-top:6px}
    .danger-text{color:#fca5a5}
    @media (max-width:1080px){
      body{padding:18px}
      .main{flex-direction:column}
      .sidebar{width:100%;flex-direction:row;flex-wrap:wrap}
      .content{padding:22px}
      .nav-btn{flex:1}
    }
    @media (max-width:768px){
      body{padding:16px 12px}
      .topbar{flex-direction:column;align-items:flex-start}
      .top-actions{align-self:stretch;flex-wrap:wrap}
      .split{grid-template-columns:1fr}
    }
    @media (max-width:520px){
      .toolbar{flex-direction:column;align-items:stretch}
      .btn,.top-btn{justify-content:center;width:100%}
      .sidebar{gap:8px}
      .nav-btn{font-size:13px;padding:10px 12px}
      .card{padding:16px}
    }
  </style>
  <script>
    window.__SUPABASE_URL__ = "https://jvnzbxmuasidddtzqycx.supabase.co";
    window.__SUPABASE_ANON_KEY__ = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2bnpieG11YXNpZGRkdHpxeWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTE0MzMsImV4cCI6MjA3ODMyNzQzM30.K6ZIZFxG9uk5YrK3Ebw2SDVX_f9ftXqrZxeeQw-Visc";
  </script>
</head>
<body>
  <div class="glow" aria-hidden="true"></div>
  <div class="dashboard">
    <header class="topbar">
      <div class="brand">
        <div class="logo">NC</div>
        <div>
          <h1>NeonCanvas</h1>
          <span>Админ хяналтын самбар · Supabase + Local data</span>
        </div>
      </div>
      <div class="top-actions">
        <div class="badge" id="role-badge">Role · N/A</div>
        <button class="top-btn" id="to-site">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9.5 8.5-1.4 1.6L19 11.5V21h-6v-5H11v5H5v-9.5L3.9 13l-1.4-1.6z"/></svg>
          Нүүр рүү очих
        </button>
        <button class="top-btn" id="logout-btn">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17l1.41-1.41L8.83 13H21v-2H8.83l2.58-2.59L10 7l-5 5 5 5zm-6 4h8v-2H6V5h6V3H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"/></svg>
          Гарах
        </button>
      </div>
    </header>

    <div id="locked" class="locked hidden">
      <h2 style="margin:0 0 8px">Зөвхөн багш / админ эрхтэй хэрэглэгч</h2>
      <p style="margin:0">Та багшийн эрхээр нэвтрээгүй байна. Login хуудсаар Teacher role-той акаунтаар нэвтрээд дахин орно уу.</p>
      <div style="margin-top:18px;display:flex;gap:12px;justify-content:center">
        <a class="top-btn" href="login.html">Нэвтрэх</a>
        <a class="top-btn" href="index.html">Нүүр</a>
      </div>
    </div>

    <div class="main" id="main-wrap">
      <aside class="sidebar">
        <button class="nav-btn is-active" data-nav="overview">Дашбоард<span>Шуурхай тойм</span></button>
        <button class="nav-btn" data-nav="posts">Контент<span>Пост, Supabase</span></button>
        <button class="nav-btn" data-nav="people">Хэрэглэгчид<span>Roles · Local</span></button>
        <button class="nav-btn" data-nav="curriculum">Хичээл · Тэмцээн<span>Lessons & Contests</span></button>
        <button class="nav-btn" data-nav="system">Систем<span>Notifications · Export</span></button>
      </aside>
      <section class="content">
        <div id="status-banner" class="status-banner" role="status"></div>

        <section class="panel is-active" data-panel="overview">
          <div class="grid metrics">
            <div class="card">
              <h3>Нийт пост (Local)</h3>
              <div class="metric-value" data-metric="local-posts">0</div>
              <div class="metric-sub">LocalStorage дахь постууд</div>
            </div>
            <div class="card">
              <h3>Supabase пост</h3>
              <div class="metric-value" data-metric="supabase-posts">0</div>
              <div class="metric-sub">Cloud дээр синк хийгдсэн өгөгдөл</div>
            </div>
            <div class="card">
              <h3>Хэрэглэгчид</h3>
              <div class="metric-value" data-metric="users">0</div>
              <div class="metric-sub">`neon_users_v1` локал бүртгэл</div>
            </div>
            <div class="card">
              <h3>Хичээл & Тэмцээн</h3>
              <div class="metric-value" data-metric="lessons-contests">0</div>
              <div class="metric-sub">Идэвхтэй lessons + contests</div>
            </div>
            <div class="card">
              <h3>Мэдэгдэл</h3>
              <div class="metric-value" data-metric="notifications">0</div>
              <div class="metric-sub">Unread / нийт</div>
            </div>
            <div class="card">
              <h3>Сүүлийн sync</h3>
              <div class="metric-value" style="font-size:18px" data-metric="synced-at">—</div>
              <div class="metric-sub">Supabase ↔ Local</div>
            </div>
          </div>

          <div class="card">
            <h3>Яаралтай авах алхам</h3>
            <p class="muted" style="margin:6px 0 16px">Платформын датаг төвлөрүүлэх, хянах гол үйлдлүүд.</p>
            <div class="toolbar">
              <button class="btn primary" id="refresh-all">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6V3L8 7l4 4V8c2.757 0 5 2.243 5 5a5 5 0 0 1-9.584 2.001l-1.832.804A7 7 0 1 0 12 6z"/></svg>
                Бүх өгөгдөл шинэчлэх
              </button>
              <button class="btn secondary" id="sync-now">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 9h16v2H4zM4 13h10v2H4z"/></svg>
                Supabase → Local буюу синк
              </button>
              <button class="btn ghost" id="export-data">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l4 4h-3v4h-2V7H8zm-6 8h2v7h12v-7h2v7a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2z"/></svg>
                Backup(JSON) татах
              </button>
            </div>
          </div>

          <div class="card split">
            <div>
              <h3 style="margin-bottom:12px">Шинэчлэлүүд</h3>
              <div class="timeline" id="activity-log"></div>
            </div>
            <div>
              <h3 style="margin-bottom:12px">LocalStorage snapshot</h3>
              <div class="list" id="storage-summary"></div>
            </div>
          </div>
        </section>

        <section class="panel" data-panel="posts">
          <div class="card">
            <div class="toolbar" style="justify-content:space-between;flex-wrap:wrap;gap:12px">
              <div>
                <h3 style="margin:0">Пост удирдлага</h3>
                <p class="muted" style="margin:4px 0 0">Supabase дахь `posts` хүснэгт болон LocalStorage дахь `neon_posts_v1`-г нэг дороос хянана.</p>
              </div>
              <div class="toolbar">
                <button class="btn primary" id="refresh-supabase">Supabase дахин ачаалах</button>
                <button class="btn secondary" id="sync-supabase-local">Supabase → Local sync</button>
                <button class="btn ghost" id="push-local-supabase">Local → Supabase (шинэ)</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">Шинэ пост нэмэх (Supabase + Local)</h3>
            <form id="post-form" class="fields two">
              <div>
                <label for="post-title">Гарчиг</label>
                <input id="post-title" placeholder="Жишээ: Typography practice" required />
              </div>
              <div>
                <label for="post-user">Хэрэглэгч</label>
                <select id="post-user"></select>
              </div>
              <div>
                <label for="post-image">Зураг / preview URL</label>
                <input id="post-image" placeholder="https://..." />
              </div>
              <div>
                <label for="post-contest">Contest ID (optional)</label>
                <input id="post-contest" placeholder="Contest id эсвэл хоосон" />
              </div>
              <div style="grid-column:1/-1">
                <label for="post-desc">Дэлгэрэнгүй</label>
                <textarea id="post-desc" placeholder="Контентын тайлбар..." required></textarea>
              </div>
              <div style="grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap">
                <button class="btn primary" type="submit">Пост үүсгэх</button>
                <button class="btn ghost" type="reset" id="post-reset">Цэвэрлэх</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">Supabase постууд</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Гарчиг</th><th>Хэн</th><th>Огноо</th><th>Оноо</th><th>ID</th><th></th></tr>
                </thead>
                <tbody id="supabase-posts"></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">LocalStorage постууд</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Гарчиг</th><th>Хэрэглэгч</th><th>Огноо</th><th>Contest</th><th>ID</th><th></th></tr>
                </thead>
                <tbody id="local-posts"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="panel" data-panel="people">
          <div class="card">
            <h3 style="margin-bottom:14px">Хэрэглэгчийн бүртгэл (`neon_users_v1`)</h3>
            <form id="user-form" class="fields two">
              <div>
                <label for="user-name">Нэр</label>
                <input id="user-name" placeholder="Жишээ: Enkhtuya D." required />
              </div>
              <div>
                <label for="user-email">Имэйл</label>
                <input id="user-email" type="email" placeholder="you@example.com" />
              </div>
              <div>
                <label for="user-role">Role</label>
                <select id="user-role">
                  <option value="student">Student</option>
                  <option value="teacher">Teacher</option>
                </select>
              </div>
              <div>
                <label for="user-initials">Товчлол</label>
                <input id="user-initials" placeholder="ED" />
              </div>
              <div style="grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap">
                <button class="btn primary" type="submit">Хэрэглэгч нэмэх</button>
                <button class="btn ghost" type="reset">Цэвэрлэх</button>
              </div>
            </form>
          </div>

          <div class="card">
            <div class="toolbar" style="justify-content:space-between">
              <div>
                <h3 style="margin:0 0 6px">Бүртгэлтэй хэрэглэгчид</h3>
                <p class="muted" style="margin:0">Role сольж, устгах боломжтой. Teacher role нь dashboard ашиглах эрхтэй.</p>
              </div>
              <button class="btn ghost" id="users-refresh">Локал өгөгдөл дахин унших</button>
            </div>
            <div class="table-wrap" style="margin-top:16px">
              <table>
                <thead>
                  <tr><th>Нэр</th><th>Имэйл</th><th>Role</th><th>Supabase ID</th><th></th></tr>
                </thead>
                <tbody id="users-table"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="panel" data-panel="curriculum">
          <div class="card">
            <h3 style="margin-bottom:12px">Contest үүсгэх</h3>
            <form id="contest-form" class="fields two">
              <div>
                <label for="contest-title">Гарчиг</label>
                <input id="contest-title" placeholder="Logo Sprint #8" required />
              </div>
              <div>
                <label for="contest-prize">Шагнал</label>
                <input id="contest-prize" placeholder="150 pts" />
              </div>
              <div style="grid-column:1/-1">
                <label for="contest-desc">Тайлбар</label>
                <textarea id="contest-desc" placeholder="Дүрэм, хугацаа, Objective..."></textarea>
              </div>
              <div style="display:flex;align-items:center;gap:10px">
                <label style="margin:0"><input type="checkbox" id="contest-announce" checked /> Home дээр мэдэгдэх</label>
              </div>
              <div style="grid-column:1/-1">
                <button class="btn primary" type="submit">Contest нэмэх</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">Contest жагсаалт</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Гарчиг</th><th>Статус</th><th>Шагнал</th><th>Үүссэн</th><th></th></tr></thead>
                <tbody id="contest-list"></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">Хичээл нэмэх</h3>
            <form id="lesson-form" class="fields two">
              <div>
                <label for="lesson-title">Гарчиг</label>
                <input id="lesson-title" placeholder="Poster critique 101" required />
              </div>
              <div>
                <label for="lesson-subject">Сэдэв</label>
                <input id="lesson-subject" placeholder="Subject / Track" />
              </div>
              <div>
                <label for="lesson-grade">Зэрэг/анги</label>
                <input id="lesson-grade" placeholder="10A" />
              </div>
              <div>
                <label for="lesson-teacher">Багш</label>
                <input id="lesson-teacher" placeholder="Teacher name" />
              </div>
              <div style="grid-column:1/-1">
                <label for="lesson-desc">Тайлбар</label>
                <textarea id="lesson-desc" placeholder="Lesson тайлбар, зорилго..."></textarea>
              </div>
              <div style="grid-column:1/-1">
                <button class="btn primary" type="submit">Хичээл нэмэх</button>
              </div>
            </form>
          </div>

          <div class="card">
            <h3 style="margin-bottom:12px">Хичээл жагсаалт</h3>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Гарчиг</th><th>Сэдэв</th><th>Grade</th><th>Асуудал / Tests</th><th>Үүссэн</th><th></th></tr></thead>
                <tbody id="lesson-list"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="panel" data-panel="system">
          <div class="card">
            <div class="toolbar" style="justify-content:space-between">
              <div>
                <h3 style="margin:0 0 6px">Notifications</h3>
                <p class="muted" style="margin:0">`neon_notifs_v1`-г удирдах, уншсан/уншаагүй тэмдэглэх.</p>
              </div>
              <div class="toolbar">
                <button class="btn ghost" id="notif-mark-read">Бүгдийг уншсан болгох</button>
                <button class="btn danger" id="notif-clear">Цэвэрлэх</button>
              </div>
            </div>
            <form id="notif-form" style="margin-top:16px" class="fields">
              <div>
                <label for="notif-text">Шинэ notification</label>
                <textarea id="notif-text" placeholder="Мэдэгдэл текст"></textarea>
              </div>
              <div>
                <button class="btn primary" type="submit">Нэмэх</button>
              </div>
            </form>
            <div class="timeline" style="margin-top:16px" id="notif-list"></div>
          </div>

          <div class="card split">
            <div>
              <h3 style="margin-bottom:12px">Background зураг</h3>
              <div class="bg-preview" id="bg-preview">Одоогийн background харагдах хэсэг</div>
              <div class="toolbar" style="margin-top:14px">
                <button class="btn secondary" id="bg-upload">Зураг сонгох</button>
                <button class="btn ghost" id="bg-reset-btn">Арилгах</button>
                <input id="bg-file" type="file" accept="image/*" hidden />
              </div>
            </div>
            <div>
              <h3 style="margin-bottom:12px">Систем үйлдлүүд</h3>
              <div class="list">
                <div class="list-item">
                  <div>
                    <strong>LocalStorage sync ping</strong>
                    <p class="muted" style="margin:4px 0 0">BroadcastChannel ашиглан бусад табтай синх хийхийн тулд санамсаргүй түлхүүр шинэчилнэ.</p>
                  </div>
                  <div class="actions">
                    <button class="btn ghost" id="ping-sync">Ping</button>
                  </div>
                </div>
                <div class="list-item">
                  <div>
                    <strong>Lesson score reset</strong>
                    <p class="muted" style="margin:4px 0 0">`neon_lpoints_v1` оноог тэглэнэ. Энэ нь leaderboard-д нөлөөлнө.</p>
                  </div>
                  <div class="actions">
                    <button class="btn danger" id="reset-scores">Оноо тэглэх</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    (function removeInjectedChat(){
      var selectors=[
        'use-chat-gpt-ai',
        'use-chat-gpt-ai-content-menu',
        '[class*="use-chat-gpt-ai"]',
        '[class*="use-chat-gpt-ai-content-menu"]'
      ];
      function purge(root){
        if(!root || !root.querySelectorAll) return;
        selectors.forEach(function(sel){
          root.querySelectorAll(sel).forEach(function(node){ try{ node.remove(); }catch(_){} });
        });
      }
      purge(document);
      var obs=new MutationObserver(function(mutations){
        mutations.forEach(function(m){
          if(m.addedNodes){
            m.addedNodes.forEach(function(node){
              if(node && node.nodeType===1){
                if(node.shadowRoot) purge(node.shadowRoot);
                purge(node);
              }
            });
          }
        });
      });
      try{ obs.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){ }
      window.addEventListener('beforeunload',function(){ try{ obs.disconnect(); }catch(_){} });
    })();

    var LOCAL_KEYS = {
      POSTS:"neon_posts_v1",
      NOTIFS:"neon_notifs_v1",
      CONTESTS:"neon_contests_v1",
      BG:"neon_bg_v1",
      ME:"neon_me_v1",
      AUTH:"neon_auth_v1",
      USERS:"neon_users_v1",
      LESSONS:"neon_lessons_v1",
      LPOINTS:"neon_lpoints_v1"
    };
    var REACTION_POINTS = { like:1, love:2, wow:1.5, fire:2.5, clap:1 };
    var SUPABASE_URL = (window.__SUPABASE_URL__||"").trim();
    var SUPABASE_ANON_KEY = (window.__SUPABASE_ANON_KEY__||"").trim();
    var POSTS_TABLE = "posts";
    var supabaseClient = null;
    if(SUPABASE_URL && SUPABASE_ANON_KEY){
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    var bus=null; try{ bus=new BroadcastChannel('neon_sync'); }catch(e){ bus=null; }
    function broadcast(type,payload){
      if(bus){ try{ bus.postMessage({type:type,payload:payload}); }catch(e){} }
      try{ localStorage.setItem('neon_ping', String(Date.now())); }catch(e){}
    }

    function esc(v){
      v = v==null? "" : String(v);
      return v.replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m];});
    }

    function safeParse(key, fallback){
      try{
        var raw = localStorage.getItem(key);
        if(!raw) return fallback;
        var val = JSON.parse(raw);
        return (typeof fallback === 'object' && fallback !== null && Array.isArray(fallback)) ? (Array.isArray(val) ? val : fallback) : (val==null ? fallback : val);
      }catch(e){
        return fallback;
      }
    }

    function persist(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){ console.warn('Persist failed', key, e); }
    }

    function formatDate(ts){
      if(!ts) return '—';
      var d = new Date(ts);
      if(isNaN(d.getTime())) return '—';
      return d.toLocaleString('mn-MN', { hour12:false });
    }

    function calcPoints(post){
      var total=0;
      var reactions = post && post.reactions || {};
      for(var k in reactions){ if(Object.prototype.hasOwnProperty.call(reactions,k)){ var mul = REACTION_POINTS[k]; if(mul==null) mul=1; total += mul * (+reactions[k]||0); } }
      return Math.round(total*10)/10;
    }

    function clonePost(post){
      try{ return JSON.parse(JSON.stringify(post)); }catch(e){ return Object.assign({}, post); }
    }

    function normaliseRow(row){
      if(!row) return null;
      var payload = row.payload;
      if(payload && typeof payload === 'string'){
        try{ payload = JSON.parse(payload); }catch(e){ payload = {}; }
      }
      var post = (payload && typeof payload === 'object') ? payload : {};
      if(!post.id) post.id = row.id || Date.now();
      if(!post.createdAt){
        post.createdAt = row.created_at ? (Date.parse(row.created_at)||Date.now()) : Date.now();
      }
      if(!post.reactions || typeof post.reactions !== 'object'){ post.reactions = {}; }
      if(!Array.isArray(post.comments)){ post.comments = []; }
      post._supabaseId = row.id || null;
      post._supabaseCreatedAt = row.created_at || null;
      post._supabaseUpdatedAt = row.updated_at || null;
      return post;
    }

    async function savePostSupabase(post){
      if(!supabaseClient){ throw new Error('Supabase client not initialised'); }
      var payload = clonePost(post);
      if(!payload.createdAt) payload.createdAt = Date.now();
      var record = { payload: payload };
      var { data, error } = await supabaseClient.from(POSTS_TABLE).insert(record).select();
      if(error){ throw error; }
      if(Array.isArray(data) && data.length){
        return normaliseRow(data[0]);
      }
      return post;
    }

    async function deletePostSupabase(post){
      if(!supabaseClient) throw new Error('Supabase client not initialised');
      if(!post) throw new Error('Missing post');
      var target = post._supabaseId || post.id;
      if(!target) throw new Error('Supabase row id not found');
      var { error } = await supabaseClient.from(POSTS_TABLE).delete().eq('id', target);
      if(error){ throw error; }
      return true;
    }

    async function loadSupabasePosts(){
      if(!supabaseClient) return [];
      var { data, error } = await supabaseClient.from(POSTS_TABLE).select('*').order('created_at', { ascending:false });
      if(error){ throw error; }
      return Array.isArray(data) ? data.map(normaliseRow).filter(Boolean) : [];
    }

    var state = {
      view:'overview',
      supabasePosts:[],
      localPosts:[],
      contests:[],
      lessons:[],
      notifications:[],
      users:[],
      lessonScores:{},
      me:null,
      auth:null,
      bg:null,
      activity:[]
    };

    var statusTimer = null;
    function setStatus(msg, type){
      var el = document.getElementById('status-banner');
      if(!el) return;
      if(statusTimer){ clearTimeout(statusTimer); statusTimer=null; }
      if(!msg){
        el.className = 'status-banner';
        el.textContent='';
        return;
      }
      el.textContent = msg;
      el.className = 'status-banner show' + (type==='success'? ' success' : type==='error'? ' error' : '');
      statusTimer = setTimeout(function(){ el.classList.remove('show','success','error'); }, 4200);
      var logEntry = { id: Date.now()+Math.random(), text: msg, type: type||'info', at: Date.now() };
      state.activity.unshift(logEntry);
      renderActivity();
    }

    function logAction(text, type){
      var entry = { id: Date.now()+Math.random(), text: text, type: type||'info', at: Date.now() };
      state.activity.unshift(entry);
      renderActivity();
    }

    function enforceRole(){
      var auth = safeParse(LOCAL_KEYS.AUTH, null) || {};
      state.auth = auth;
      var me = safeParse(LOCAL_KEYS.ME, null) || {};
      state.me = me;
      var role = auth && auth.role;
      var badge = document.getElementById('role-badge');
      if(badge){
        var name = me && me.name ? me.name : 'User';
        badge.textContent = (role ? role.toUpperCase() : 'NO ROLE') + ' · ' + name;
      }
      var allowed = role === 'teacher' || role === 'admin';
      if(!allowed){
        document.getElementById('locked').classList.remove('hidden');
        document.getElementById('main-wrap').classList.add('hidden');
        setStatus('Dashboard нь зөвхөн Teacher / Admin role-д зориулагдсан.', 'error');
        return false;
      }
      document.getElementById('locked').classList.add('hidden');
      document.getElementById('main-wrap').classList.remove('hidden');
      return true;
    }

    function loadLocalData(){
      state.localPosts = safeParse(LOCAL_KEYS.POSTS, []);
      state.contests = safeParse(LOCAL_KEYS.CONTESTS, []);
      state.lessons = safeParse(LOCAL_KEYS.LESSONS, []);
      state.notifications = safeParse(LOCAL_KEYS.NOTIFS, []);
      state.users = safeParse(LOCAL_KEYS.USERS, []);
      state.lessonScores = safeParse(LOCAL_KEYS.LPOINTS, {});
      state.bg = safeParse(LOCAL_KEYS.BG, null);
    }

    function renderMetrics(){
      var unread = state.notifications.filter(function(n){return !n.read;}).length;
      var totalNotifs = state.notifications.length;
      var metrics = {
        'local-posts': state.localPosts.length,
        'supabase-posts': state.supabasePosts.length,
        'users': state.users.length,
        'lessons-contests': state.lessons.length + state.contests.length,
        'notifications': unread + ' / ' + totalNotifs
      };
      Object.keys(metrics).forEach(function(key){
        var el = document.querySelector('[data-metric="'+key+'"]');
        if(el){ el.textContent = metrics[key]; }
      });
    }

    function renderStorageSummary(){
      var box = document.getElementById('storage-summary');
      if(!box) return;
      var items = [
        { key: LOCAL_KEYS.POSTS, label:'neon_posts_v1', size: state.localPosts.length + ' posts' },
        { key: LOCAL_KEYS.USERS, label:'neon_users_v1', size: state.users.length + ' users' },
        { key: LOCAL_KEYS.LESSONS, label:'neon_lessons_v1', size: state.lessons.length + ' lessons' },
        { key: LOCAL_KEYS.CONTESTS, label:'neon_contests_v1', size: state.contests.length + ' contests' },
        { key: LOCAL_KEYS.NOTIFS, label:'neon_notifs_v1', size: state.notifications.length + ' notifications' }
      ];
      box.innerHTML = items.map(function(item){
        var raw = localStorage.getItem(item.key)||'';
        var kb = (raw.length/1024).toFixed(1);
        return '<div class="list-item" style="flex-direction:column;align-items:flex-start">'+
          '<div><strong>'+esc(item.label)+'</strong> <span class="pill">'+esc(item.size)+'</span></div>'+(
            kb ? '<div class="muted" style="font-size:12px">~'+kb+' KB</div>' : ''
          )+
        '</div>';
      }).join('');
    }

    function renderActivity(){
      var box = document.getElementById('activity-log');
      if(!box) return;
      if(!state.activity.length){
        box.innerHTML = '<div class="muted">Одоогоор activity бүртгэлгүй.</div>';
        return;
      }
      box.innerHTML = state.activity.slice(0,8).map(function(item){
        var tone = item.type==='error' ? 'danger-text' : item.type==='success' ? 'badge-soft' : 'muted';
        return '<div class="timeline-item">'+
          '<div>'+esc(item.text)+'</div>'+ 
          '<small>' + formatDate(item.at) + '</small>'+
        '</div>';
      }).join('');
    }

    function renderSupabasePosts(){
      var tbody = document.getElementById('supabase-posts');
      if(!tbody) return;
      if(!state.supabasePosts.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Supabase дээр пост байхгүй байна.</td></tr>';
        return;
      }
      tbody.innerHTML = state.supabasePosts.map(function(post){
        return '<tr>'+ 
          '<td>'+esc(post.title||'—')+'</td>'+ 
          '<td>'+esc(resolveUserName(post.userId))+'</td>'+ 
          '<td>'+formatDate(post.createdAt)+'</td>'+ 
          '<td>'+calcPoints(post)+'</td>'+ 
          '<td>'+esc(post._supabaseId||post.id)+'</td>'+ 
          '<td><button class="btn ghost" data-sup-delete="'+esc(post._supabaseId||post.id)+'">Устгах</button></td>'+ 
        '</tr>';
      }).join('');
    }

    function renderLocalPosts(){
      var tbody = document.getElementById('local-posts');
      if(!tbody) return;
      if(!state.localPosts.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">LocalStorage дахь пост байхгүй байна.</td></tr>';
        return;
      }
      tbody.innerHTML = state.localPosts.map(function(post){
        return '<tr>'+ 
          '<td>'+esc(post.title||'—')+'</td>'+ 
          '<td>'+esc(resolveUserName(post.userId))+'</td>'+ 
          '<td>'+formatDate(post.createdAt)+'</td>'+ 
          '<td>'+esc(post.contestId||'—')+'</td>'+ 
          '<td>'+esc(post.id)+'</td>'+ 
          '<td><button class="btn ghost" data-local-delete="'+esc(post.id)+'">Устгах</button></td>'+ 
        '</tr>';
      }).join('');
    }

    function resolveUserName(userId){
      var id = Number(userId);
      if(!id){ return '—'; }
      for(var i=0;i<state.users.length;i++){ if(state.users[i].id === id){ return state.users[i].name || ('User '+id); } }
      if(state.me && state.me.id === id){ return state.me.name || 'Me'; }
      return 'User '+id;
    }

    function populateUserOptions(){
      var select = document.getElementById('post-user');
      if(!select) return;
      var options = state.users.map(function(user){
        return '<option value="'+user.id+'">'+esc(user.name || ('User '+user.id))+'</option>';
      });
      options.unshift('<option value="">Гишүүн сонгоно уу (ID)</option>');
      select.innerHTML = options.join('');
    }

    function renderUsers(){
      var tbody = document.getElementById('users-table');
      if(!tbody) return;
      if(!state.users.length){
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Хэрэглэгч бүртгэгдээгүй байна.</td></tr>';
        return;
      }
      tbody.innerHTML = state.users.map(function(user){
        return '<tr>'+
          '<td>'+esc(user.name||'—')+'</td>'+
          '<td>'+esc(user.email||'—')+'</td>'+
          '<td>'+esc(user.role||'student')+'</td>'+
          '<td>'+esc(user.supabaseId||'—')+'</td>'+
          '<td style="display:flex;gap:8px">'+
            '<button class="btn secondary" data-user-toggle="'+user.id+'">Role солих</button>'+
            '<button class="btn ghost" data-user-remove="'+user.id+'">Устгах</button>'+
          '</td>'+ 
        '</tr>';
      }).join('');
    }

    function renderContests(){
      var tbody = document.getElementById('contest-list');
      if(!tbody) return;
      if(!state.contests.length){
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Contest бүртгэгдээгүй.</td></tr>';
        return;
      }
      tbody.innerHTML = state.contests.map(function(contest){
        return '<tr>'+
          '<td>'+esc(contest.title||'—')+'</td>'+
          '<td>'+esc(contest.status||'open')+'</td>'+
          '<td>'+esc(contest.prize||'—')+'</td>'+
          '<td>'+formatDate(contest.createdAt)+'</td>'+
          '<td style="display:flex;gap:8px">'+
            '<button class="btn ghost" data-contest-toggle="'+contest.id+'">Статус</button>'+
            '<button class="btn danger" data-contest-remove="'+contest.id+'">Устгах</button>'+
          '</td>'+ 
        '</tr>';
      }).join('');
    }

    function renderLessons(){
      var tbody = document.getElementById('lesson-list');
      if(!tbody) return;
      if(!state.lessons.length){
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Хичээл бүртгэгдээгүй.</td></tr>';
        return;
      }
      tbody.innerHTML = state.lessons.map(function(lesson){
        var quizCount = (lesson.quiz && lesson.quiz.length) || 0;
        return '<tr>'+ 
          '<td>'+esc(lesson.title||'—')+'</td>'+ 
          '<td>'+esc(lesson.subject||'—')+'</td>'+ 
          '<td>'+esc(lesson.grade||'—')+'</td>'+ 
          '<td>'+quizCount+'</td>'+ 
          '<td>'+formatDate(lesson.createdAt)+'</td>'+ 
          '<td><button class="btn ghost" data-lesson-remove="'+lesson.id+'">Устгах</button></td>'+ 
        '</tr>';
      }).join('');
    }

    function renderNotifications(){
      var box = document.getElementById('notif-list');
      if(!box) return;
      if(!state.notifications.length){
        box.innerHTML = '<div class="muted">Мэдэгдэл хоосон байна.</div>';
        return;
      }
      box.innerHTML = state.notifications.slice(0,20).map(function(n){
        var status = n.read ? '<span class="pill">READ</span>' : '<span class="pill" style="background:rgba(236,72,153,.16);border:1px solid rgba(236,72,153,.35);color:#fbcfe8">NEW</span>';
        return '<div class="timeline-item">'+
          '<div style="display:flex;justify-content:space-between;gap:12px"><div>'+esc(n.text||'—')+'</div>'+status+'</div>'+ 
          '<small>'+formatDate(n.time||n.at||Date.now())+'</small>'+
        '</div>';
      }).join('');
    }

    function renderBackgroundPreview(){
      var box = document.getElementById('bg-preview');
      if(!box) return;
      if(state.bg && state.bg.dataUrl){
        box.innerHTML = '<img src="'+esc(state.bg.dataUrl)+'" alt="Background preview" />';
      }else{
        box.textContent = 'Background тохируулаагүй байна.';
      }
    }

    function setView(view){
      state.view = view;
      document.querySelectorAll('.nav-btn').forEach(function(btn){ btn.classList.toggle('is-active', btn.getAttribute('data-nav')===view); });
      document.querySelectorAll('.panel').forEach(function(panel){ panel.classList.toggle('is-active', panel.getAttribute('data-panel')===view); });
    }

    async function refreshSupabase(){
      if(!supabaseClient){
        setStatus('Supabase тохиргоо олдсонгүй. Dashboard-ийн head хэсэгт URL/key зөв эсэхийг шалгана уу.', 'error');
        return;
      }
      try{
        var posts = await loadSupabasePosts();
        state.supabasePosts = posts;
  renderSupabasePosts();
  renderMetrics();
  var syncEl = document.querySelector('[data-metric="synced-at"]');
  if(syncEl){ syncEl.textContent = formatDate(Date.now()); }
        setStatus('Supabase-ээс '+posts.length+' пост амжилттай уншлаа.', 'success');
      }catch(err){
        console.error(err);
        setStatus('Supabase-ээс татахад алдаа гарлаа: '+(err.message||err), 'error');
      }
    }

    function syncSupabaseToLocal(){
      if(!state.supabasePosts.length){
        setStatus('Supabase дээр синк хийх пост олдсонгүй.', 'error');
        return;
      }
      var clone = state.supabasePosts.map(function(post){ return clonePost(post); });
      state.localPosts = clone;
      persist(LOCAL_KEYS.POSTS, state.localPosts);
      renderLocalPosts();
      renderMetrics();
      broadcast('POSTS_UPDATED', null);
      var syncEl = document.querySelector('[data-metric="synced-at"]');
      if(syncEl){ syncEl.textContent = formatDate(Date.now()); }
      setStatus('Supabase → Local sync амжилттай.', 'success');
      logAction('Supabase → Local sync хийгдэв', 'success');
    }

    async function pushLocalToSupabase(){
      if(!supabaseClient){ setStatus('Supabase client идэвхгүй.', 'error'); return; }
      var pending = state.localPosts.filter(function(post){ return !post._supabaseId; });
      if(!pending.length){ setStatus('Supabase-д нэмж илгээх шинэ пост байхгүй.', 'error'); return; }
      var created = 0;
      for(var i=0;i<pending.length;i++){
        var post = pending[i];
        try{
          var saved = await savePostSupabase(post);
          if(saved){
            created++;
            post._supabaseId = saved._supabaseId || saved.id;
            post._supabaseCreatedAt = saved._supabaseCreatedAt || saved.createdAt || post.createdAt;
            post._supabaseUpdatedAt = saved._supabaseUpdatedAt || saved.updatedAt || post.createdAt;
          }
        }catch(err){
          console.error('Push post failed', err);
          setStatus('Алдаа: '+(err.message||err), 'error');
          return;
        }
      }
      if(created){
        persist(LOCAL_KEYS.POSTS, state.localPosts);
        broadcast('POSTS_UPDATED', null);
        await refreshSupabase();
        setStatus(created+' пост Supabase руу дамжууллаа.', 'success');
        logAction(created+' local пост Supabase руу илгээлээ', 'success');
      }
    }

    function addLocalPost(post){
      var stored = clonePost(post);
      state.localPosts.unshift(stored);
      persist(LOCAL_KEYS.POSTS, state.localPosts);
      renderLocalPosts();
      renderMetrics();
      broadcast('POSTS_UPDATED', null);
      return stored;
    }

    function removeLocalPost(id){
      var idx = state.localPosts.findIndex(function(post){ return String(post.id) === String(id); });
      if(idx===-1) return;
      state.localPosts.splice(idx,1);
      persist(LOCAL_KEYS.POSTS, state.localPosts);
      renderLocalPosts();
      renderMetrics();
      broadcast('POSTS_UPDATED', null);
      setStatus('LocalStorage post устгалаа.', 'success');
      logAction('Local post '+id+' устгав', 'info');
    }

    async function removeSupabasePost(id){
      var post = state.supabasePosts.find(function(p){ return String(p._supabaseId||p.id)===String(id); });
      if(!post){ setStatus('Supabase пост олдсонгүй.', 'error'); return; }
      if(!confirm('Энэ постыг Supabase дээрээс устгах уу?')) return;
      try{
        await deletePostSupabase(post);
        state.supabasePosts = state.supabasePosts.filter(function(p){ return (p._supabaseId||p.id)!==post._supabaseId; });
        renderSupabasePosts();
        renderMetrics();
        setStatus('Supabase пост устгалаа.', 'success');
        logAction('Supabase post '+id+' устгав', 'success');
        await refreshSupabase();
      }catch(err){
        console.error(err);
        setStatus('Устгах явцад алдаа гарлаа: '+(err.message||err), 'error');
      }
    }

    function handleNavClick(ev){
      var btn = ev.target.closest('[data-nav]');
      if(!btn) return;
      setView(btn.getAttribute('data-nav'));
    }

    function handlePostForm(ev){
      ev.preventDefault();
      var title = (document.getElementById('post-title').value||'').trim();
      var desc = (document.getElementById('post-desc').value||'').trim();
      var image = (document.getElementById('post-image').value||'').trim();
      var contestId = (document.getElementById('post-contest').value||'').trim();
      var userIdRaw = document.getElementById('post-user').value;
      if(!title || !desc){ setStatus('Гарчиг болон тайлбар шаардлагатай.', 'error'); return; }
      var userId = userIdRaw ? Number(userIdRaw) : (state.me && state.me.id) || Date.now();
      var post = {
        id: Date.now(),
        userId: userId,
        title: title,
        description: desc,
        image: image || null,
        contestId: contestId || null,
        reactions:{},
        comments:[],
        createdAt: Date.now()
      };
      var stored = addLocalPost(post);
      if(supabaseClient){
        savePostSupabase(post).then(function(saved){
          if(saved && saved._supabaseId){
            var idx = state.localPosts.findIndex(function(item){ return String(item.id) === String(stored.id); });
            if(idx !== -1){
              state.localPosts[idx]._supabaseId = saved._supabaseId;
              state.localPosts[idx]._supabaseCreatedAt = saved._supabaseCreatedAt;
              state.localPosts[idx]._supabaseUpdatedAt = saved._supabaseUpdatedAt;
              persist(LOCAL_KEYS.POSTS, state.localPosts);
              renderLocalPosts();
            }
          }
          setStatus('Пост Supabase дээр амжилттай хадгалагдлаа.', 'success');
          logAction('Шинэ пост үүсгэв', 'success');
          refreshSupabase();
        }).catch(function(err){
          console.error(err);
          setStatus('Supabase хадгалах үед алдаа гарлаа: '+(err.message||err), 'error');
        });
      }else{
        setStatus('Supabase client идэвхгүй. Пост зөвхөн Local-д нэмэгдлээ.', 'error');
      }
      (document.getElementById('post-form')||{}).reset();
    }

    function addUser(ev){
      ev.preventDefault();
      var name = (document.getElementById('user-name').value||'').trim();
      var email = (document.getElementById('user-email').value||'').trim();
      var role = document.getElementById('user-role').value||'student';
      var initials = (document.getElementById('user-initials').value||'').trim();
      if(!name){ setStatus('Нэр шаардлагатай.', 'error'); return; }
      var user = {
        id: Date.now(),
        name: name,
        email: email,
        role: role,
        avatar: initials || name.split(' ').map(function(s){return s[0];}).join('').slice(0,2).toUpperCase(),
        initials: initials,
        supabaseId: null
      };
      state.users.push(user);
      persist(LOCAL_KEYS.USERS, state.users);
      renderUsers();
      populateUserOptions();
      renderMetrics();
      broadcast('USERS_UPDATED', null);
      setStatus('Хэрэглэгч амжилттай нэмэгдлээ.', 'success');
      (document.getElementById('user-form')||{}).reset();
    }

    function toggleUserRole(id){
      var idx = state.users.findIndex(function(u){ return String(u.id)===String(id); });
      if(idx===-1) return;
      var role = state.users[idx].role==='teacher' ? 'student' : 'teacher';
      state.users[idx].role = role;
      persist(LOCAL_KEYS.USERS, state.users);
      renderUsers();
      populateUserOptions();
      renderMetrics();
      broadcast('USERS_UPDATED', null);
      setStatus('Role '+role+' болгон шинэчиллээ.', 'success');
    }

    function removeUser(id){
      var idx = state.users.findIndex(function(u){ return String(u.id)===String(id); });
      if(idx===-1) return;
      if(!confirm('Энэ хэрэглэгчийг бүртгэлээс устгах уу?')) return;
      state.users.splice(idx,1);
      persist(LOCAL_KEYS.USERS, state.users);
      renderUsers();
      populateUserOptions();
      renderMetrics();
      broadcast('USERS_UPDATED', null);
      setStatus('Хэрэглэгч устгалаа.', 'success');
    }

    function addContest(ev){
      ev.preventDefault();
      var title = (document.getElementById('contest-title').value||'').trim();
      var prize = (document.getElementById('contest-prize').value||'').trim();
      var desc = (document.getElementById('contest-desc').value||'').trim();
      var announce = document.getElementById('contest-announce').checked;
      if(!title){ setStatus('Contest гарчиг шаардлагатай.', 'error'); return; }
      var contest = {
        id: Date.now(),
        title: title,
        prize: prize,
        description: desc,
        status: 'open',
        entries: [],
        createdAt: Date.now(),
        announced: false
      };
      state.contests.unshift(contest);
      persist(LOCAL_KEYS.CONTESTS, state.contests);
      renderContests();
      renderMetrics();
      broadcast('CONTESTS_UPDATED', null);
      setStatus('Contest нэмэгдлээ.', 'success');
      if(announce){
        var post = {
          id: Date.now()+1,
          userId: (state.me && state.me.id) || 0,
          title: '🏁 '+contest.title,
          description: 'Prize: '+(prize||'—')+(desc? ' — '+desc:''),
          image: null,
          contestId: contest.id,
          type: 'contest_announcement',
          reactions:{},
          comments:[],
          createdAt: Date.now()
        };
        addLocalPost(post);
        if(supabaseClient){ savePostSupabase(post).catch(function(err){ console.warn('Contest announce supabase fail', err); }); }
      }
      (document.getElementById('contest-form')||{}).reset();
    }

    function toggleContest(id){
      var idx = state.contests.findIndex(function(c){ return String(c.id)===String(id); });
      if(idx===-1) return;
      state.contests[idx].status = state.contests[idx].status==='open'? 'closed':'open';
      persist(LOCAL_KEYS.CONTESTS, state.contests);
      renderContests();
      renderMetrics();
      broadcast('CONTESTS_UPDATED', null);
      setStatus('Contest '+state.contests[idx].status+' болголоо.', 'success');
    }

    function removeContest(id){
      var idx = state.contests.findIndex(function(c){ return String(c.id)===String(id); });
      if(idx===-1) return;
      if(!confirm('Contest устгах уу? Энэ нь постуудыг устгахгүй.')) return;
      state.contests.splice(idx,1);
      persist(LOCAL_KEYS.CONTESTS, state.contests);
      renderContests();
      renderMetrics();
      broadcast('CONTESTS_UPDATED', null);
      setStatus('Contest устгалаа.', 'success');
    }

    function addLesson(ev){
      ev.preventDefault();
      var title = (document.getElementById('lesson-title').value||'').trim();
      if(!title){ setStatus('Lesson гарчиг шаардлагатай.', 'error'); return; }
      var lesson = {
        id: Date.now(),
        title: title,
        subject: (document.getElementById('lesson-subject').value||'').trim(),
        grade: (document.getElementById('lesson-grade').value||'').trim(),
        teacher: (document.getElementById('lesson-teacher').value||'').trim(),
        description: (document.getElementById('lesson-desc').value||'').trim(),
        files: [],
        quiz: [],
        createdAt: Date.now(),
        attempts: []
      };
      state.lessons.unshift(lesson);
      persist(LOCAL_KEYS.LESSONS, state.lessons);
      renderLessons();
      renderMetrics();
      broadcast('LESSONS_UPDATED', null);
      setStatus('Хичээл нэмэгдлээ.', 'success');
      (document.getElementById('lesson-form')||{}).reset();
    }

    function removeLesson(id){
      var idx = state.lessons.findIndex(function(l){ return String(l.id)===String(id); });
      if(idx===-1) return;
      if(!confirm('Энэ хичээлийг устгах уу?')) return;
      state.lessons.splice(idx,1);
      persist(LOCAL_KEYS.LESSONS, state.lessons);
      renderLessons();
      renderMetrics();
      broadcast('LESSONS_UPDATED', null);
      setStatus('Хичээл устгалаа.', 'success');
    }

    function addNotification(ev){
      ev.preventDefault();
      var text = (document.getElementById('notif-text').value||'').trim();
      if(!text){ setStatus('Notification текст оруулна уу.', 'error'); return; }
      var notif = { id: Date.now()+Math.random(), text: text, time: Date.now(), read: false };
      state.notifications.unshift(notif);
      persist(LOCAL_KEYS.NOTIFS, state.notifications);
      renderNotifications();
      renderMetrics();
      broadcast('NOTIFICATIONS_UPDATED', null);
      setStatus('Notification нэмэгдлээ.', 'success');
      (document.getElementById('notif-form')||{}).reset();
    }

    function markAllNotificationsRead(){
      state.notifications.forEach(function(n){ n.read = true; });
      persist(LOCAL_KEYS.NOTIFS, state.notifications);
      renderNotifications();
      renderMetrics();
      broadcast('NOTIFICATIONS_UPDATED', null);
      setStatus('Бүх notification-ийг уншсан болголоо.', 'success');
    }

    function clearNotifications(){
      if(!confirm('Бүх notification-ийг арилгах уу?')) return;
      state.notifications = [];
      persist(LOCAL_KEYS.NOTIFS, state.notifications);
      renderNotifications();
      renderMetrics();
      broadcast('NOTIFICATIONS_UPDATED', null);
      setStatus('Notifications цэвэрлэгдлээ.', 'success');
    }

    function updateBackground(file){
      var reader = new FileReader();
      reader.onload = function(){
        var dataUrl = reader.result;
        state.bg = { dataUrl:dataUrl };
        persist(LOCAL_KEYS.BG, state.bg);
        renderBackgroundPreview();
        broadcast('BG_UPDATED', { dataUrl:dataUrl });
        setStatus('Background шинэчлэгдлээ.', 'success');
      };
      reader.readAsDataURL(file);
    }

    function resetBackground(){
      state.bg = null;
      try{ localStorage.removeItem(LOCAL_KEYS.BG); }catch(e){}
      renderBackgroundPreview();
      broadcast('BG_UPDATED', null);
      setStatus('Background арилгалаа.', 'success');
    }

    function exportData(){
      var bundle = {
        exportedAt: new Date().toISOString(),
        posts: state.localPosts,
        contests: state.contests,
        lessons: state.lessons,
        notifications: state.notifications,
        users: state.users,
        lessonScores: state.lessonScores
      };
      var dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(bundle,null,2));
      var a = document.createElement('a');
      a.setAttribute('href', dataStr);
      a.setAttribute('download', 'neoncanvas-dashboard-backup-'+Date.now()+'.json');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setStatus('Backup(JSON) татагдлаа.', 'success');
    }

    function resetLessonScores(){
      if(!confirm('Lesson оноог бүгдийг 0 болгох уу?')) return;
      state.lessonScores = {};
      persist(LOCAL_KEYS.LPOINTS, state.lessonScores);
      broadcast('LESSON_SCORES_UPDATED', null);
      setStatus('Lesson оноо тэгллээ.', 'success');
    }

    function pingSync(){
      broadcast('PING', { at: Date.now() });
      setStatus('BroadcastChannel ping илгээлээ.', 'success');
    }

    function attachEvents(){
      document.querySelector('.sidebar').addEventListener('click', handleNavClick);
      var postForm = document.getElementById('post-form'); if(postForm) postForm.addEventListener('submit', handlePostForm);
      var userForm = document.getElementById('user-form'); if(userForm) userForm.addEventListener('submit', addUser);
      var contestForm = document.getElementById('contest-form'); if(contestForm) contestForm.addEventListener('submit', addContest);
      var lessonForm = document.getElementById('lesson-form'); if(lessonForm) lessonForm.addEventListener('submit', addLesson);
      var notifForm = document.getElementById('notif-form'); if(notifForm) notifForm.addEventListener('submit', addNotification);

      document.getElementById('refresh-supabase').addEventListener('click', refreshSupabase);
      document.getElementById('sync-supabase-local').addEventListener('click', syncSupabaseToLocal);
      document.getElementById('push-local-supabase').addEventListener('click', pushLocalToSupabase);
      document.getElementById('refresh-all').addEventListener('click', function(){ loadLocalData(); renderAll(); if(supabaseClient) refreshSupabase(); setStatus('Локал өгөгдөл дахин уншлаа.', 'success'); });
      document.getElementById('sync-now').addEventListener('click', syncSupabaseToLocal);
      document.getElementById('export-data').addEventListener('click', exportData);
      document.getElementById('notif-mark-read').addEventListener('click', markAllNotificationsRead);
      document.getElementById('notif-clear').addEventListener('click', clearNotifications);
      document.getElementById('bg-upload').addEventListener('click', function(){ document.getElementById('bg-file').click(); });
      document.getElementById('bg-file').addEventListener('change', function(ev){ var file = ev.target.files && ev.target.files[0]; if(file) updateBackground(file); });
      document.getElementById('bg-reset-btn').addEventListener('click', resetBackground);
      document.getElementById('reset-scores').addEventListener('click', resetLessonScores);
      document.getElementById('ping-sync').addEventListener('click', pingSync);
      document.getElementById('users-refresh').addEventListener('click', function(){ loadLocalData(); renderUsers(); renderMetrics(); populateUserOptions(); setStatus('Users локал өгөгдэл дахин уншлаа.', 'success'); });
      document.getElementById('logout-btn').addEventListener('click', function(){ try{ localStorage.setItem(LOCAL_KEYS.AUTH, JSON.stringify({ loggedIn:false })); }catch(e){} broadcast('AUTH_CHANGED', { loggedIn:false }); window.location.href='login.html'; });
      document.getElementById('to-site').addEventListener('click', function(){ window.location.href = 'index.html'; });

      document.getElementById('supabase-posts').addEventListener('click', function(ev){ var btn = ev.target.closest('[data-sup-delete]'); if(btn){ removeSupabasePost(btn.getAttribute('data-sup-delete')); } });
      document.getElementById('local-posts').addEventListener('click', function(ev){ var btn = ev.target.closest('[data-local-delete]'); if(btn){ removeLocalPost(btn.getAttribute('data-local-delete')); } });
      document.getElementById('users-table').addEventListener('click', function(ev){ var toggle = ev.target.closest('[data-user-toggle]'); var removeBtn = ev.target.closest('[data-user-remove]'); if(toggle){ toggleUserRole(toggle.getAttribute('data-user-toggle')); } if(removeBtn){ removeUser(removeBtn.getAttribute('data-user-remove')); } });
      document.getElementById('contest-list').addEventListener('click', function(ev){ var toggle = ev.target.closest('[data-contest-toggle]'); var removeBtn = ev.target.closest('[data-contest-remove]'); if(toggle){ toggleContest(toggle.getAttribute('data-contest-toggle')); } if(removeBtn){ removeContest(removeBtn.getAttribute('data-contest-remove')); } });
      document.getElementById('lesson-list').addEventListener('click', function(ev){ var removeBtn = ev.target.closest('[data-lesson-remove]'); if(removeBtn){ removeLesson(removeBtn.getAttribute('data-lesson-remove')); } });
    }

    function renderAll(){
      renderSupabasePosts();
      renderLocalPosts();
      renderUsers();
      renderContests();
      renderLessons();
      renderNotifications();
      renderBackgroundPreview();
      renderMetrics();
      renderStorageSummary();
      renderActivity();
      populateUserOptions();
    }

    function init(){
      if(!enforceRole()) return;
      loadLocalData();
      renderAll();
      attachEvents();
      setStatus('Dashboard бэлэн боллоо.', 'success');
      if(supabaseClient){ refreshSupabase(); }
    }

    init();
  </script>
</body>
</html>
